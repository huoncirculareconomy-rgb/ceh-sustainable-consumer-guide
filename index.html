<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>CEH Sustainable Consumer Guide</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<style>
/* =====================
   BASE STYLES
===================== */
:root{
  --bg:#f3f1ec;
  --panel:#f8f7f4;
  --card:#fbfaf8;
  --border:#ddd;
  --text:#24323f;
  --muted:#666;
  --title:#2f8f5b;

  --blue-bg:#e6f0ff;
  --blue-border:#bcd2ff;
  --blue-text:#2457c5;

  --green-bg:#e7f5ea;
  --green-border:#bfe3cc;
  --green-text:#1b7f4d;

  --btn-blue:#1a73e8;
}

body{
  margin:0;
  font-family: system-ui, Arial, sans-serif;
  background: var(--bg);
  color: var(--text);
}

.container{
  max-width:1200px;
  margin:0 auto;
  padding:20px 14px 30px;
  background:var(--panel);
  border-radius:14px;
}

/* =====================
   HEADER
===================== */
h1{
  margin:0;
  text-align:center;
  color:var(--title);
  font-size:40px;
}

#slogan{
  text-align:center;
  font-style:italic;
  color:#444;
  margin:8px auto 18px;
  max-width:720px;
  min-height:1.4em;
}

/* =====================
   FILTERS
===================== */
.filters{
  display:flex;
  flex-wrap:wrap;
  gap:10px;
  padding-bottom:12px;
  border-bottom:1px solid #e0e0e0;
}

.filters input,
.filters select{
  height:42px;
  padding:8px 12px;
  font-size:14px;
  border:1px solid #777;
  background:#fff;
}

#searchInput{flex:1 1 420px;}
#locationFilter,#practiceFilter{flex:0 0 220px;}

#resetBtn{
  height:42px;
  padding:0 14px;
  border-radius:6px;
  border:1px solid var(--btn-blue);
  background:var(--btn-blue);
  color:#fff;
  font-weight:600;
  cursor:pointer;
}

#resetBtn:hover{opacity:.9}

@media(max-width:800px){
  #searchInput,#locationFilter,#practiceFilter,#resetBtn{
    flex:1 1 100%;
  }
}

.results-count{
  margin:10px 0 14px;
  font-size:13px;
  font-weight:500;
}

/* =====================
   CARDS
===================== */
.cards{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(320px,1fr));
  gap:16px;
}

.card{
  background:var(--card);
  border:1px solid var(--border);
  border-radius:14px;
  padding:14px;
  box-shadow:
    0 1px 2px rgba(0,0,0,.04),
    0 3px 6px rgba(0,0,0,.03);
}

.card h3{
  margin:0 0 6px;
  font-size:16px;
}

/* Product / Service text */
.desc{
  font-size:14px;
  line-height:1.45;
  white-space:pre-wrap;
}

/* Micro-polish: slightly emphasise first line */
.desc::first-line{
  font-weight:500;
}

/* =====================
   PILLS
===================== */
.pill{
  display:inline-block;
  padding:4px 10px;
  font-size:12px;
  border-radius:999px;
  margin:4px 6px 0 0;
  cursor:pointer;
}

.pill.category{
  background:var(--blue-bg);
  border:1px solid var(--blue-border);
  color:var(--blue-text);
}

.pill.practice{
  background:var(--green-bg);
  border:1px solid var(--green-border);
  color:var(--green-text);
}

/* =====================
   CONTACT & LINKS
===================== */
.contact{
  margin-top:10px;
  font-size:13px;
}

.contact-row{
  display:flex;
  gap:8px;
  margin-top:4px;
}

.icon{width:16px;opacity:.8}

.contact a{
  font-size:13px;
  color:#1a73e8;
  text-decoration:none;
}

.contact a:hover{text-decoration:underline}

/* =====================
   NOTES
===================== */
.notes{
  margin-top:10px;
  padding-top:8px;
  border-top:1px solid #eee;
  font-style:italic;
  font-size:13px;
  color:#777;
}

/* =====================
   FOOTER
===================== */
.footer{
  margin-top:22px;
  text-align:center;
  font-size:12px;
  color:var(--muted);
}

/* =====================
   PRINT MODE
===================== */
@media print{
  body,.container{background:#fff}
  .filters,.results-count,#resetBtn{display:none}
  .cards{display:block}
  .card{page-break-inside:avoid;border-radius:0;box-shadow:none}
  .pill{background:none;border:none;color:#000;padding:0}
  .icon{display:none}
  a[href]:after{
    content:" (" attr(href) ")";
    font-size:9pt;
    color:#555;
  }
}
</style>
</head>

<body>
<div class="container">
  <h1>CEH Sustainable Consumer Guide</h1>
  <div id="slogan">Loading‚Ä¶</div>

  <div class="filters">
    <input id="searchInput" placeholder="Search name, product, category or practice‚Ä¶">
    <select id="locationFilter"><option value="">All locations</option></select>
    <select id="practiceFilter"><option value="">All practices</option></select>
    <button id="resetBtn">Reset filters</button>
  </div>

  <div class="results-count" id="resultsCount"></div>
  <div class="cards" id="cards"></div>

  <div class="footer" id="lastUpdated"></div>
</div>

<script>
/* =====================
   CONFIG
===================== */
const SHEET_ID="1Nm4LnfbmopYYSSRL6oGt2trWsIehBKYeUf_rl2pKYYg";
const DATA_GID="2076497318";
const SLOGAN_GID="435440157";

const DATA_URL=`https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=${DATA_GID}`;
const SLOGAN_URL=`https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=${SLOGAN_GID}`;

let all=[],filtered=[];
let search="",loc="",prac="",cat="";

/* =====================
   HELPERS
===================== */
const norm=s=>(s||"").trim();
const split=s=>[...new Set(norm(s).split(",").map(x=>x.trim()).filter(Boolean))];
const urls=t=>(t.match(/\b(https?:\/\/|www\.)\S+/gi)||[]).map(u=>u.startsWith("http")?u:`https://${u}`);
const mapLink=(a,g)=>g?`https://maps.google.com/?q=${encodeURIComponent(g)}`:
  a?`https://maps.google.com/?q=${encodeURIComponent(a)}`:"";

/* Format Product / Service text */
function formatProductService(text){
  if(!text) return "";
  const sentences = text
    .split(/\. +/)
    .map(s=>s.trim())
    .filter(Boolean)
    .map(s=>s.endsWith(".")?s:s+".");
  return sentences.map(s=>`> ${s}`).join("\n");
}

/* =====================
   SLOGANS (Row 4‚Äì16)
===================== */
let slogans=[],si=0,st;
Papa.parse(SLOGAN_URL,{
  download:true,
  complete:r=>{
    slogans=r.data.slice(3,16).map(x=>({
      t:norm(x[0]),u:norm(x[1]),s:+x[2]||5
    })).filter(x=>x.t);
    rotate();
  }
});

function rotate(){
  if(!slogans.length)return;
  const s=slogans[si];
  slogan.innerHTML=s.u?`<a href="${s.u}" target="_blank">${s.t}</a>`:s.t;
  clearTimeout(st);
  st=setTimeout(()=>{si=(si+1)%slogans.length;rotate()},s.s*1000);
}

/* =====================
   DATA
===================== */
Papa.parse(DATA_URL,{
  download:true,
  header:true,
  complete:r=>{
    all=r.data.filter(x=>!x.Status||x.Status==="Active");
    all.sort((a,b)=>Date.parse(b.Date||0)-Date.parse(a.Date||0));
    buildFilters();
    apply();
    lastUpdated.textContent=
      "Data last updated: "+
      new Date(Math.max(...all.map(x=>Date.parse(x.Date)||0)))
      .toLocaleDateString();
  }
});

function buildFilters(){
  const L=new Set(),P=new Set();
  all.forEach(r=>{
    split(r.Location).forEach(x=>L.add(x));
    split(r.Practices).forEach(x=>P.add(x));
  });
  locationFilter.innerHTML='<option value="">All locations</option>'+
    [...L].sort().map(x=>`<option>${x}</option>`).join("");
  practiceFilter.innerHTML='<option value="">All practices</option>'+
    [...P].sort().map(x=>`<option>${x}</option>`).join("");
}

/* =====================
   RENDER
===================== */
function apply(){
  filtered=all.filter(r=>{
    const h=(r.Name+r["Product/Service"]+r.Category+r.Practices).toLowerCase();
    if(search&&!h.includes(search))return false;
    if(loc&&!split(r.Location).includes(loc))return false;
    if(prac&&!split(r.Practices).includes(prac))return false;
    if(cat&&!split(r.Category).includes(cat))return false;
    return true;
  });

  resultsCount.textContent=`Showing ${filtered.length} of ${all.length} results`;
  cards.innerHTML="";

  filtered.forEach(r=>{
    const c=document.createElement("div");
    c.className="card";

    c.innerHTML=`<h3>${r.Name}</h3>
      <div class="desc">${formatProductService(norm(r["Product/Service"]))}</div>`;

    split(r.Category).forEach(x=>{
      c.innerHTML+=`<span class="pill category" onclick="cat='${x}';apply()">${x}</span>`;
    });

    split(r.Practices).forEach(x=>{
      c.innerHTML+=`<span class="pill practice" onclick="prac='${x}';practiceFilter.value='${x}';apply()">${x}</span>`;
    });

    const con=document.createElement("div");
    con.className="contact";

    urls(r.Website).forEach(u=>{
      con.innerHTML+=`<div class="contact-row"><span class="icon">üîó</span><a href="${u}" target="_blank">${u}</a></div>`;
    });

    if(r.Phone)con.innerHTML+=`<div class="contact-row"><span class="icon">üìû</span>${r.Phone}</div>`;
    if(r.Email)con.innerHTML+=`<div class="contact-row"><span class="icon">‚úâÔ∏è</span>${r.Email}</div>`;
    if(r.Address||r.Geolocation){
      const m=mapLink(r.Address,r.Geolocation);
      con.innerHTML+=`<div class="contact-row"><span class="icon">üìç</span><a href="${m}" target="_blank">${r.Address||r.Geolocation}</a></div>`;
    }

    if(con.innerHTML)c.appendChild(con);
    if(r.Notes)c.innerHTML+=`<div class="notes">${r.Notes}</div>`;

    cards.appendChild(c);
  });
}

/* =====================
   EVENTS
===================== */
searchInput.oninput=e=>{search=e.target.value.toLowerCase();apply()}
locationFilter.onchange=e=>{loc=e.target.value;apply()}
practiceFilter.onchange=e=>{prac=e.target.value;apply()}
resetBtn.onclick=()=>{search=loc=prac=cat="";searchInput.value="";locationFilter.value="";practiceFilter.value="";apply()}
</script>
</body>
</html>
