<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">

<title>CEH Sustainable Consumer Guide</title>

<style>
/* =========================================================
   PURPOSE & FUNCTION
   ---------------------------------------------------------
   This script renders the Circular Economy Huon Sustainable
   Consumer Guide from a Google Sheets CSV. It displays
   businesses as cards with search and filters, clickable
   category and practice pills, contact details, and links.
   Notes are shown at the bottom of each card in a subdued
   style, and physical addresses link to Google Maps.
   ========================================================= */

body {
  margin: 0;
  font-family: system-ui, Arial, sans-serif;
  background: transparent;
}

/* Layout */
.container {
  padding: 12px;
}

/* Search */
.search-wrap {
  margin-bottom: 12px;
}
.search-wrap input {
  width: 100%;
  max-width: 100%;
  padding: 10px;
  font-size: 14px;
  border-radius: 6px;
  border: 1px solid #ccc;
  box-sizing: border-box;
}

/* Cards */
.cards {
  display: grid;
  grid-template-columns: 1fr;
  gap: 12px;
}
@media (min-width: 768px) {
  .cards {
    grid-template-columns: repeat(2, 1fr);
  }
}
@media (min-width: 1100px) {
  .cards {
    grid-template-columns: repeat(3, 1fr);
  }
}

.card {
  border: 1px solid #ddd;
  border-radius: 10px;
  padding: 12px;
  background: #fff;
}

.card-title {
  font-weight: 700;
  font-size: 16px;
  margin-bottom: 6px;
}

.card-product {
  margin-bottom: 8px;
  line-height: 1.35;
}

/* Pills */
.pills {
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
  margin-bottom: 8px;
}

.pill-category {
  background: #1a73e8;
  color: #fff;
  border-radius: 999px;
  padding: 3px 10px;
  font-size: 12px;
  cursor: pointer;
}

.pill-practice {
  background: #e6f4ea;
  color: #137333;
  border-radius: 999px;
  padding: 3px 10px;
  font-size: 12px;
  cursor: pointer;
}

/* Contact details */
.contact {
  font-size: 13px;
  margin-top: 6px;
}
.contact-item {
  margin-bottom: 4px;
}
.contact-item a {
  color: #1a73e8;
  text-decoration: none;
  font-size: 13px;
}
.contact-item a:hover {
  text-decoration: underline;
}

/* Notes */
.notes {
  margin-top: 10px;
  padding-top: 8px;
  border-top: 1px solid #eee;
  color: #777;
  font-style: italic;
  font-size: 13px;
}
</style>
</head>

<body>
<div class="container">

  <div class="search-wrap">
    <input id="search" type="text" placeholder="Search name, product, category or practiceâ€¦">
  </div>

  <div id="cards" class="cards"></div>

</div>

<script>
/* =======================
   CONFIG
   ======================= */
const CSV_URL =
  "https://docs.google.com/spreadsheets/d/e/2PACX-1vSuhA8ku2ftsdQaepAZucZWIHmVuwaLO2xq8_d8y5QIOBfCwRBDsWH9A5crAbsAcK3TFM1fcWMTVJjs/pub?gid=2076497318&single=true&output=csv";

/* =======================
   HELPERS
   ======================= */
function parseCSV(text) {
  const lines = text.split(/\r?\n/).filter(Boolean);
  const headers = lines.shift().split(",").map(h => h.trim());
  return lines.map(line => {
    const cells = line.split(",");
    const obj = {};
    headers.forEach((h, i) => obj[h] = (cells[i] || "").trim());
    return obj;
  });
}

function splitList(value) {
  if (!value) return [];
  return value.split(",").map(v => v.trim()).filter(Boolean);
}

function extractLinks(value) {
  if (!value) return [];
  const matches = value.match(/(https?:\/\/[^\s,]+|www\.[^\s,]+)/gi) || [];
  return matches.map(u => u.startsWith("http") ? u : "https://" + u);
}

function mapLink(address) {
  return "https://www.google.com/maps/search/?api=1&query=" +
         encodeURIComponent(address);
}

/* =======================
   STATE
   ======================= */
let allRows = [];
let filteredRows = [];
let activeCategory = null;
let activePractices = new Set();

/* =======================
   RENDER
   ======================= */
function render() {
  const wrap = document.getElementById("cards");
  wrap.innerHTML = "";

  filteredRows.forEach(r => {
    const card = document.createElement("div");
    card.className = "card";

    /* Category pills */
    const categories = splitList(r.Category);
    const catHTML = categories.map(c =>
      `<span class="pill-category" data-cat="${c}">${c}</span>`
    ).join("");

    /* Practice pills */
    const practices = splitList(r.Practices);
    const pracHTML = practices.map(p =>
      `<span class="pill-practice" data-prac="${p.toLowerCase()}">${p}</span>`
    ).join("");

    /* Website links */
    const linksHTML = extractLinks(r.Website).map(url =>
      `<div class="contact-item">
        <a href="${url}" target="_blank">${url}</a>
      </div>`
    ).join("");

    /* Address with Google Maps */
    const addressHTML = r.Address
      ? `<div class="contact-item">
           <a href="${mapLink(r.Address)}" target="_blank">${r.Address}</a>
         </div>`
      : "";

    card.innerHTML = `
      <div class="card-title">${r.Name || ""}</div>
      <div class="card-product">${r["Product/Service"] || ""}</div>

      <div class="pills">${catHTML}</div>
      <div class="pills">${pracHTML}</div>

      <div class="contact">
        ${linksHTML}
        ${r.Phone ? `<div class="contact-item">${r.Phone}</div>` : ""}
        ${r.Email ? `<div class="contact-item">${r.Email}</div>` : ""}
        ${addressHTML}
      </div>

      ${r.Notes ? `<div class="notes">${r.Notes}</div>` : ""}
    `;

    wrap.appendChild(card);
  });
}

/* =======================
   FILTERING
   ======================= */
function applyFilters() {
  const q = document.getElementById("search").value.toLowerCase();

  filteredRows = allRows.filter(r => {
    if (activeCategory && !splitList(r.Category).includes(activeCategory)) {
      return false;
    }
    if (activePractices.size) {
      const rowPractices = splitList(r.Practices).map(p => p.toLowerCase());
      if (![...activePractices].some(p => rowPractices.includes(p))) {
        return false;
      }
    }
    return (
      (r.Name || "").toLowerCase().includes(q) ||
      (r["Product/Service"] || "").toLowerCase().includes(q)
    );
  });

  render();
}

/* =======================
   EVENTS
   ======================= */
document.addEventListener("click", e => {
  if (e.target.classList.contains("pill-category")) {
    activeCategory = e.target.dataset.cat;
    applyFilters();
  }
  if (e.target.classList.contains("pill-practice")) {
    const p = e.target.dataset.prac;
    activePractices.has(p) ? activePractices.delete(p) : activePractices.add(p);
    applyFilters();
  }
});

document.getElementById("search").addEventListener("input", applyFilters);

/* =======================
   INIT
   ======================= */
fetch(CSV_URL)
  .then(r => r.text())
  .then(text => {
    allRows = parseCSV(text)
      .filter(r => !r.Status || r.Status.toLowerCase() === "active");
    filteredRows = allRows;
    render();
  });
</script>
</body>
</html>
