<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>CEH Sustainable Consumer Guide</title>

<!--
PURPOSE & FUNCTION
This page loads data from the CEH Sustainable Consumer Guide Google Sheet
using Google's official gviz JSON endpoint, explicitly targeting the
correct sheet tab by gid. It renders the data as a searchable and
filterable card-based directory. Locations and Practices are normalised
so combined entries are split into individual filter options.
-->

<style>
  body {
    margin: 0;
    padding: 20px;
    font-family: system-ui, Arial, sans-serif;
    background: #f6f3ee;
  }

  h1 {
    margin: 0 0 6px;
    color: #2e8b57;
  }

  .subtitle {
    font-style: italic;
    margin-bottom: 20px;
    color: #444;
  }

<div class="filters">
  <input id="search" placeholder="Search businesses or services">
  <select id="locationFilter">
    <option value="">All locations</option>
  </select>
  <select id="practiceFilter">
    <option value="">All practices</option>
  </select>
  <button id="resetFilters" type="button">Reset filters</button>
</div>

}

/* Mobile: stack filters vertically */
@media (max-width: 700px) {
  .filters {
    grid-template-columns: 1fr;
  }
}

  }

  input, select {
    padding: 10px;
    font-size: 16px;
  }

  .cards {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 16px;
  }

  .card {
    background: #fff;
    border-radius: 8px;
    padding: 14px;
    box-shadow: 0 1px 4px rgba(0,0,0,0.1);
  }

  .card h3 {
    margin: 0 0 6px;
  }

  .muted {
    color: #666;
    font-size: 0.9rem;
  }

  .tag {
    display: inline-block;
    background: #e0f2e9;
    color: #205c3b;
    padding: 3px 8px;
    border-radius: 12px;
    font-size: 12px;
    margin: 2px 4px 2px 0;
  }

  a {
    color: #1a5fb4;
    text-decoration: none;
  }
</style>
</head>

<body>

<h1>CEH Sustainable Consumer Guide</h1>
<div class="subtitle">Choose local. Reduce waste. Strengthen the Huon Valley.</div>

<div class="filters">
  <input id="search" placeholder="Search businesses or services">
  <select id="locationFilter">
    <option value="">All locations</option>
  </select>
  <select id="practiceFilter">
    <option value="">All practices</option>
  </select>
</div>

<div id="cards" class="cards"></div>

<script>
/* ================= CONFIG ================= */

const SHEET_ID = "1Nm4LnfbmopYYSSRL6oGt2trWsIehBKYeUf_rl2pKYYg";
const SHEET_GID = "2076497318";

const GVIZ_URL =
  `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?gid=${SHEET_GID}&tqx=out:json`;

/* ================= STATE ================= */

const cardsEl = document.getElementById("cards");
const searchEl = document.getElementById("search");
const locEl = document.getElementById("locationFilter");
const pracEl = document.getElementById("practiceFilter");

let rows = [];

/* ================= HELPERS ================= */

function splitTokens(str) {
  if (!str) return [];
  return str.split(/[,;/|]/).map(s => s.trim()).filter(Boolean);
}

function norm(str) {
  return str.toLowerCase().replace(/\s+/g, " ").trim();
}

/* ================= RENDER ================= */

function renderFilters() {
  const locations = [...new Set(
    rows.flatMap(r => splitTokens(r.Location))
  )].sort();

  const practices = [...new Set(
    rows.flatMap(r => splitTokens(r.Practices))
  )].sort();

  locations.forEach(l => {
    const o = document.createElement("option");
    o.value = l;
    o.textContent = l;
    locEl.appendChild(o);
  });

  practices.forEach(p => {
    const o = document.createElement("option");
    o.value = p;
    o.textContent = p;
    pracEl.appendChild(o);
  });
}

function renderCards() {
  const q = norm(searchEl.value);
  const loc = norm(locEl.value);
  const prac = norm(pracEl.value);

  cardsEl.innerHTML = "";

  rows.filter(r => {
    const text =
      norm(`${r.Name} ${r["Product/Service"]} ${r.Category}`);

    const locMatch =
      !loc || splitTokens(r.Location).map(norm).includes(loc);

    const pracMatch =
      !prac || splitTokens(r.Practices).map(norm).includes(prac);

    return (!q || text.includes(q)) && locMatch && pracMatch;
  }).forEach(r => {
    const card = document.createElement("div");
    card.className = "card";

    card.innerHTML = `
      <h3>${r.Name}</h3>
      <div class="muted">${r["Product/Service"]}</div>
      ${r.Notes ? `<p>${r.Notes}</p>` : ""}
      <div>
        ${splitTokens(r.Practices).map(p =>
          `<span class="tag">${p}</span>`).join("")}
      </div>
      ${r.Website ? `<p><a href="${r.Website}" target="_blank">Website</a></p>` : ""}
    `;

    cardsEl.appendChild(card);
  });
}

/* ================= LOAD ================= */

fetch(GVIZ_URL)
  .then(r => r.text())
  .then(text => {
    const json = JSON.parse(
      text.substring(text.indexOf("{"), text.lastIndexOf("}") + 1)
    );

    const headers = json.table.cols.map(c => c.label);

    rows = json.table.rows
      .map(r => {
        const obj = {};
        r.c.forEach((cell, i) => {
          obj[headers[i]] = cell ? cell.v : "";
        });
        return obj;
      })
      .filter(r => r.Status && r.Status.toLowerCase() !== "inactive");

    renderFilters();
    renderCards();
  });

searchEl.addEventListener("input", renderCards);
locEl.addEventListener("change", renderCards);
pracEl.addEventListener("change", renderCards);
</script>

</body>
</html>


