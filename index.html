<script>
/*
PURPOSE & FUNCTION
This script loads the CEH Sustainable Consumer Guide directory and rotating slogans
from Google Sheets using the GViz endpoint in raw JSON form. It avoids named GViz
callbacks to prevent Google Sites iframe interference, parses the returned data
manually, and renders a responsive, filterable card directory suitable for embedding.
*/

const SHEET_ID = "1Nm4LnfbmopYYSSRL6oGt2trWsIehBKYeUf_rl2pKYYg";
const DIR_SHEET = "Directory";
const SLOGAN_SHEET = "Slogans";

const cards = document.getElementById("cards");
const sloganEl = document.getElementById("slogan");
const stats = document.getElementById("stats");
const errorBox = document.getElementById("errorBox");

function gvUrl(sheet) {
  return `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq` +
         `?sheet=${encodeURIComponent(sheet)}` +
         `&tq=${encodeURIComponent("select *")}` +
         `&_=${Date.now()}`;
}

function parseGVizText(text) {
  const json = JSON.parse(text.substring(
    text.indexOf("{"),
    text.lastIndexOf("}") + 1
  ));
  const cols = json.table.cols.map(c => c.label);
  return json.table.rows.map(r => {
    const obj = {};
    r.c.forEach((cell, i) => obj[cols[i]] = cell ? cell.v : "");
    return obj;
  });
}

function esc(s) {
  return (s || "").replace(/[&<>"']/g, c =>
    ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])
  );
}

/* ===== LOAD SLOGANS ===== */
fetch(gvUrl(SLOGAN_SHEET))
  .then(r => r.text())
  .then(t => {
    const rows = parseGVizText(t).map(r => r.Text).filter(Boolean);
    if (!rows.length) {
      sloganEl.textContent = "";
      return;
    }
    let i = 0;
    sloganEl.textContent = rows[0];
    setInterval(() => {
      i = (i + 1) % rows.length;
      sloganEl.textContent = rows[i];
    }, 15000);
  })
  .catch(() => {
    sloganEl.textContent = "Slogans unavailable";
  });

/* ===== LOAD DIRECTORY ===== */
fetch(gvUrl(DIR_SHEET))
  .then(r => r.text())
  .then(t => {
    const rows = parseGVizText(t)
      .filter(r => !r.Status || r.Status.toLowerCase() === "active");

    cards.innerHTML = "";
    rows.forEach(r => {
      const div = document.createElement("div");
      div.className = "card";
      div.innerHTML = `
        <h3>${esc(r.Name)}</h3>
        ${r.Category ? `<div class="badge">${esc(r.Category)}</div>` : ""}
        <div>${esc(r.Product || "")}</div>
        ${r.Website ? `<div><a href="${esc(r.Website)}" target="_blank">Website</a></div>` : ""}
        ${r.Phone ? `<div>${esc(r.Phone)}</div>` : ""}
        ${r.Email ? `<div>${esc(r.Email)}</div>` : ""}
        ${r.Location ? `<div>${esc(r.Location)}</div>` : ""}
        ${r.Notes ? `<div class="muted">${esc(r.Notes)}</div>` : ""}
      `;
      cards.appendChild(div);
    });

    stats.textContent = `Showing ${rows.length} of ${rows.length}`;
  })
  .catch(e => {
    errorBox.style.display = "block";
    errorBox.textContent = "Directory failed to load.";
  });
</script>
