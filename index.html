<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">

<!--
PURPOSE & FUNCTION
This page implements the CEH Sustainable Consumer Guide as a standalone web app.
It loads directory data from a published Google Sheets CSV, renders responsive
cards, and provides client-side search plus Location and Practices filters.
All filtering is done in-browser for reliability and performance.
-->

<title>CEH Sustainable Consumer Guide</title>

<style>
  body {
    margin: 0;
    font-family: system-ui, Arial, sans-serif;
    background: #f7f5f2;
    color: #111;
  }
  header {
    padding: 20px;
    text-align: center;
    background: #f5f2ef;
    border-bottom: 1px solid #e5e7eb;
  }
  h1 {
    margin: 0;
    color: #2e8b57;
    font-weight: 600;
  }
  .controls {
    padding: 12px;
    background: #ffffff;
    border-bottom: 1px solid #e5e7eb;
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    justify-content: center;
  }
  .controls input,
  .controls select {
    padding: 10px 12px;
    font-size: 15px;
    border: 1px solid #cbd5e1;
    border-radius: 6px;
    min-width: 220px;
  }
  .status {
    padding: 10px;
    font-style: italic;
    color: #555;
    text-align: center;
  }
  .cards {
    padding: 16px;
    display: grid;
    grid-template-columns: 1fr;
    gap: 12px;
  }
  @media (min-width: 700px) {
    .cards { grid-template-columns: repeat(2, 1fr); }
  }
  @media (min-width: 1100px) {
    .cards { grid-template-columns: repeat(3, 1fr); }
  }
  .card {
    background: #fff;
    border: 1px solid #d1d5db;
    border-radius: 12px;
    padding: 12px;
  }
  .card h3 {
    margin: 0 0 6px 0;
    font-size: 16px;
  }
  .muted {
    color: #6b7280;
    font-style: italic;
    font-size: 14px;
  }
</style>
</head>

<body>

<header>
  <h1>CEH Sustainable Consumer Guide</h1>
</header>

<div class="controls">
  <input
    type="text"
    id="searchBox"
    placeholder="Search name, product/service or location…"
    aria-label="Search directory"
  >

  <select id="locationFilter" aria-label="Filter by location">
    <option value="">All locations</option>
  </select>

  <select id="practiceFilter" aria-label="Filter by practices">
    <option value="">All practices</option>
  </select>
</div>

<div id="status" class="status">Loading directory…</div>
<div id="cards" class="cards"></div>

<script>
/* ===== CONFIG ===== */

const CSV_URL =
  "https://docs.google.com/spreadsheets/d/e/2PACX-1vSuhA8ku2ftsdQaepAZucZWIHmVuwaLO2xq8_d8y5QIOBfCwRBDsWH9A5crAbsAcK3TFM1fcWMTVJjs/pub?gid=2076497318&single=true&output=csv";

/* ===== UTILITIES ===== */

function escapeHTML(s) {
  return (s || "").replace(/[&<>"']/g, c =>
    ({ "&":"&amp;", "<":"&lt;", ">":"&gt;", "\"":"&quot;", "'":"&#39;" }[c])
  );
}

function parseCSV(text) {
  const rows = [];
  let row = [], cell = "", inQuotes = false;

  for (let i = 0; i < text.length; i++) {
    const c = text[i], n = text[i + 1];
    if (c === '"') {
      if (inQuotes && n === '"') { cell += '"'; i++; }
      else { inQuotes = !inQuotes; }
    } else if (c === ',' && !inQuotes) {
      row.push(cell); cell = "";
    } else if ((c === '\n' || c === '\r') && !inQuotes) {
      if (cell || row.length) { row.push(cell); rows.push(row); }
      row = []; cell = "";
    } else {
      cell += c;
    }
  }
  if (cell || row.length) { row.push(cell); rows.push(row); }

  const headers = rows.shift().map(h => h.trim());
  return rows
    .filter(r => r.some(v => v && v.trim()))
    .map(r => {
      const obj = {};
      headers.forEach((h, i) => obj[h] = (r[i] || "").trim());
      return obj;
    });
}

/* ===== STATE ===== */

let allData = [];

/* ===== RENDER ===== */

function render(data) {
  const cards = document.getElementById("cards");
  const status = document.getElementById("status");

  cards.innerHTML = "";

  if (!data.length) {
    status.textContent = "No matching entries.";
    return;
  }

  data.forEach(r => {
    const card = document.createElement("div");
    card.className = "card";
    card.innerHTML = `
      <h3>${escapeHTML(r.Name)}</h3>
      <div>${escapeHTML(r["Product / Service"] || r.Product || "")}</div>
      ${r.Location ? `<div class="muted">${escapeHTML(r.Location)}</div>` : ""}
    `;
    cards.appendChild(card);
  });

  status.textContent = "Showing " + data.length + " entries";
}

/* ===== FILTERING ===== */

function applyFilters() {
  const q = document.getElementById("searchBox").value.toLowerCase();
  const loc = document.getElementById("locationFilter").value;
  const prac = document.getElementById("practiceFilter").value;

  const filtered = allData.filter(r => {
    const textMatch =
      (r.Name || "").toLowerCase().includes(q) ||
      (r["Product / Service"] || r.Product || "").toLowerCase().includes(q) ||
      (r.Location || "").toLowerCase().includes(q);

    const locMatch = !loc || (r.Location || "") === loc;

    const pracMatch =
      !prac ||
      (r.Practices || "")
        .toLowerCase()
        .split(/[,;]+/)
        .map(s => s.trim())
        .includes(prac);

    return textMatch && locMatch && pracMatch;
  });

  render(filtered);
}

/* ===== LOAD DATA ===== */

fetch(CSV_URL + "&_=" + Date.now())
  .then(r => r.text())
  .then(text => {
    allData = parseCSV(text)
      .filter(r => !r.Status || r.Status.toLowerCase() === "active");

    // Populate Location filter
    const locations = [...new Set(
      allData.map(r => r.Location).filter(Boolean)
    )].sort();

    const locSel = document.getElementById("locationFilter");
    locations.forEach(l => {
      const o = document.createElement("option");
      o.value = l;
      o.textContent = l;
      locSel.appendChild(o);
    });

    // Populate Practices filter
    const practices = [...new Set(
      allData.flatMap(r =>
        (r.Practices || "")
          .split(/[,;]+/)
          .map(s => s.trim().toLowerCase())
          .filter(Boolean)
      )
    )].sort();

    const pracSel = document.getElementById("practiceFilter");
    practices.forEach(p => {
      const o = document.createElement("option");
      o.value = p;
      o.textContent = p.charAt(0).toUpperCase() + p.slice(1);
      pracSel.appendChild(o);
    });

    render(allData);
  })
  .catch(() => {
    document.getElementById("status").textContent =
      "Directory failed to load.";
  });

/* ===== EVENTS ===== */

document.getElementById("searchBox").addEventListener("input", applyFilters);
document.getElementById("locationFilter").addEventListener("change", applyFilters);
document.getElementById("practiceFilter").addEventListener("change", applyFilters);
</script>

</body>
</html>
