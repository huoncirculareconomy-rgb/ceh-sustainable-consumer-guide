<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />

<!--
PURPOSE & FUNCTION
This page implements the CEH Sustainable Consumer Guide as a standalone web application.
It loads directory listings and rotating slogans from Google Sheets using the Google
Visualization (GViz) JSON endpoint, parses the returned table data, and renders the
results as responsive cards with search, location, and practice filters.
It is designed for external hosting (GitHub Pages) and safe embedding in Google Sites.
-->

<title>CEH Sustainable Consumer Guide</title>

<style>
*{box-sizing:border-box}
body{
  margin:0;
  font-family:system-ui,Arial,sans-serif;
  background:#fff;
  color:#111
}
.header{
  text-align:center;
  padding:18px;
  background:#f5f2ef;
  border-bottom:1px solid #e5e7eb
}
h1{margin:0;color:#2e8b57}
.slogan{margin-top:8px;font-style:italic;color:#444}
.controls{
  padding:12px;
  border-bottom:1px solid #e5e7eb
}
.controls-row{
  display:flex;
  flex-wrap:wrap;
  gap:10px;
  align-items:center
}
input,select,button{
  padding:8px;
  font-size:14px;
  border:1px solid #ccc;
  border-radius:8px
}
.cards{
  padding:14px;
  display:grid;
  gap:12px;
  grid-template-columns:1fr
}
@media(min-width:700px){
  .cards{grid-template-columns:repeat(2,1fr)}
}
@media(min-width:1100px){
  .cards{grid-template-columns:repeat(3,1fr)}
}
.card{
  border:1px solid #d1d5db;
  border-radius:12px;
  padding:12px;
  background:#fff
}
.card h3{margin:0 0 6px}
.badge{
  display:inline-block;
  font-size:12px;
  padding:2px 8px;
  border-radius:999px;
  background:#eef2ff;
  color:#3730a3;
  margin-bottom:6px
}
.muted{color:#6b7280;font-style:italic}
.error{
  margin:12px;
  padding:10px;
  border:1px solid #ef4444;
  background:#fef2f2;
  color:#991b1b;
  border-radius:10px
}
.footer{
  text-align:center;
  font-size:13px;
  color:#555;
  padding:16px;
  font-style:italic
}
</style>
</head>

<body>

<div class="header">
  <h1>CEH Sustainable Consumer Guide</h1>
  <div id="slogan" class="slogan">Loading…</div>
</div>

<div class="controls">
  <div class="controls-row">
    <strong>Filters</strong>
    <input id="search" placeholder="Search…" />
    <select id="locationSelect" multiple></select>
    <select id="practiceSelect" multiple></select>
    <button id="resetBtn">Reset filters</button>
    <span id="stats" class="muted">Loading…</span>
  </div>
</div>

<div id="errorBox" class="error" style="display:none"></div>

<div id="cards" class="cards">
  <div class="muted">Loading directory…</div>
</div>

<div id="lastUpdated" class="footer"></div>

<script>
/* ================= CONFIG ================= */
const SHEET_ID = "1Nm4LnfbmopYYSSRL6oGt2trWsIehBKYeUf_rl2pKYYg";
const DIRECTORY_SHEET = "Directory";
const SLOGAN_SHEET = "Slogans";

/* ================= STATE ================= */
let rows = [];
let filtered = [];

/* ================= HELPERS ================= */
const esc = s => (s||"").replace(/[&<>"']/g,c=>(
  {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]
));

const parseList = s => (s||"").split(/[;,|]/).map(v=>v.trim()).filter(Boolean);

/* ================= FILTERS ================= */
function applyFilters(){
  const q = search.value.toLowerCase();
  const locs = [...locationSelect.selectedOptions].map(o=>o.value);
  const pracs = [...practiceSelect.selectedOptions].map(o=>o.value);

  filtered = rows.filter(r=>{
    const text = Object.values(r).join(" ").toLowerCase();
    const locMatch = !locs.length || locs.some(l=>parseList(r.Location).includes(l));
    const pracMatch = !pracs.length || pracs.some(p=>parseList(r.Practices).includes(p));
    return (!q || text.includes(q)) && locMatch && pracMatch;
  });

  render();
}

/* ================= RENDER ================= */
function render(){
  cards.innerHTML = "";
  if(!filtered.length){
    cards.innerHTML = "<div class='muted'>No results found.</div>";
  }
  filtered.forEach(r=>{
    const div = document.createElement("div");
    div.className="card";
    div.innerHTML = `
      <h3>${esc(r.Name)}</h3>
      ${r.Category?`<div class="badge">${esc(r.Category)}</div>`:""}
      <div>${esc(r.Product||"")}</div>
      ${r.Website?`<div><a href="${esc(r.Website)}" target="_blank">Website</a></div>`:""}
      ${r.Phone?`<div>${esc(r.Phone)}</div>`:""}
      ${r.Email?`<div>${esc(r.Email)}</div>`:""}
      ${r.Location?`<div>${esc(r.Location)}</div>`:""}
      ${r.Notes?`<div class="muted">${esc(r.Notes)}</div>`:""}
    `;
    cards.appendChild(div);
  });
  stats.textContent = `Showing ${filtered.length} of ${rows.length}`;
}

/* ================= GVIZ PARSING ================= */
function parseGViz(resp){
  const cols = resp.table.cols.map(c=>c.label);
  return resp.table.rows.map(r=>{
    const o = {};
    r.c.forEach((cell,i)=>o[cols[i]] = cell ? cell.v : "");
    return o;
  });
}

/* ================= LOADERS ================= */
function loadSheet(sheet, handler){
  const s = document.createElement("script");
  s.src =
    `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq` +
    `?sheet=${encodeURIComponent(sheet)}` +
    `&tq=${encodeURIComponent("select *")}` +
    `&tqx=${encodeURIComponent("responseHandler:"+handler)}` +
    `&_=${Date.now()}`;
  document.body.appendChild(s);
}

/* ================= HANDLERS ================= */
function handleDirectory(resp){
  try{
    rows = parseGViz(resp).filter(r=>!r.Status || r.Status.toLowerCase()==="active");
    filtered = rows;

    const locs = [...new Set(rows.flatMap(r=>parseList(r.Location)))].sort();
    const pracs = [...new Set(rows.flatMap(r=>parseList(r.Practices)))].sort();

    locationSelect.innerHTML = locs.map(l=>`<option>${esc(l)}</option>`).join("");
    practiceSelect.innerHTML = pracs.map(p=>`<option>${esc(p)}</option>`).join("");

    applyFilters();
    lastUpdated.textContent = "Last updated: " + new Date().toLocaleDateString("en-AU");
  }catch(e){
    errorBox.style.display="block";
    errorBox.textContent="Directory processing error: "+e.message;
  }
}

function handleSlogans(resp){
  try{
    const items = parseGViz(resp).map(r=>r.Text).filter(Boolean);
    if(!items.length){ slogan.textContent=""; return; }
    let i=0;
    slogan.textContent=items[0];
    setInterval(()=>{
      i=(i+1)%items.length;
      slogan.textContent=items[i];
    },15000);
  }catch(e){
    slogan.textContent="Slogans unavailable";
  }
}

/* ================= EVENTS ================= */
search.oninput = applyFilters;
locationSelect.onchange = applyFilters;
practiceSelect.onchange = applyFilters;
resetBtn.onclick = ()=>{
  search.value="";
  locationSelect.selectedIndex=-1;
  practiceSelect.selectedIndex=-1;
  applyFilters();
};

/* ================= INIT ================= */
loadSheet(SLOGAN_SHEET,"handleSlogans");
loadSheet(DIRECTORY_SHEET,"handleDirectory");
</script>

</body>
</html>
