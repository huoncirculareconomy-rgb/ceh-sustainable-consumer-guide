<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>CEH Sustainable Consumer Guide</title>

<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<style>
:root{
  --bg:#f6f3ef;
  --panel:#fbf8f4;
  --card:#f8f6f3;
  --border:#d9d9d9;
  --text:#24323f;
  --muted:#777;
  --title:#2e8b57;

  --blue-bg:#e6f0ff;
  --blue-bd:#bcd2ff;
  --blue-tx:#0b3ea9;

  --green-bg:#e7f6ea;
  --green-bd:#b9e2c2;
  --green-tx:#1a6b2f;

  --active:#000;

  --btn:#1f66d1;
  --btn-dark:#154ea3;
}

*{ box-sizing:border-box }

body{
  margin:0;
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  background:var(--bg);
  color:var(--text);
}

.wrap{
  max-width:1200px;
  margin:auto;
  padding:22px 18px 28px;
}

h1{
  text-align:center;
  color:var(--title);
  margin:8px 0 4px;
}

.slogan{
  text-align:center;
  font-style:italic;
  min-height:1.4em;
  margin-bottom:18px;
}

.controls{
  background:var(--panel);
  border:1px solid var(--border);
  border-radius:12px;
  padding:14px;
  box-shadow:0 1px 3px rgba(0,0,0,.08);
}

.controls-row{
  display:flex;
  flex-wrap:wrap;
  gap:10px;
}

.input,.select,.btn{
  height:42px;
  padding:0 12px;
  font-size:14px;
  border-radius:8px;
  border:1px solid #7d7d7d;
  background:#fff;
}

.input{ flex:1 1 360px; }
.select{ flex:0 1 220px; }

.btn{
  background:var(--btn);
  color:#fff;
  border-color:var(--btn);
  font-weight:700;
  cursor:pointer;
}
.btn:hover{ background:var(--btn-dark); }

.meta{
  margin-top:10px;
  font-size:13px;
  color:var(--muted);
}

.grid{
  margin-top:16px;
  display:grid;
  grid-template-columns:repeat(3,1fr);
  gap:16px;
}

@media(max-width:900px){
  .grid{ grid-template-columns:repeat(2,1fr); }
}
@media(max-width:600px){
  .grid{ grid-template-columns:1fr; }
}

.card{
  background:var(--card);
  border:1px solid var(--border);
  border-radius:12px;
  padding:14px;
  box-shadow:0 1px 3px rgba(0,0,0,.08);
}

.name{
  font-weight:800;
  margin-bottom:8px;
}

.bullets{
  display:grid;
  gap:6px;
  margin-bottom:10px;
}

.bullet{
  display:grid;
  grid-template-columns:14px 1fr;
  gap:6px;
  font-size:13.5px;
}

.chev{ font-weight:700; }

.pills{
  display:flex;
  flex-wrap:wrap;
  gap:6px;
  margin-bottom:8px;
}

.pill{
  font-size:12px;
  padding:3px 9px;
  border-radius:999px;
  border:1px solid transparent;
  background:none;
  cursor:pointer;
}

.pill.blue{
  background:var(--blue-bg);
  border-color:var(--blue-bd);
  color:var(--blue-tx);
}

.pill.green{
  background:var(--green-bg);
  border-color:var(--green-bd);
  color:var(--green-tx);
}

.pill.active{
  outline:2px solid var(--active);
  font-weight:700;
}

.links{
  border-top:1px solid #e5e5e5;
  padding-top:8px;
  font-size:12.5px;
}

.notes{
  border-top:1px solid #e5e5e5;
  margin-top:8px;
  padding-top:8px;
  font-size:12.5px;
  font-style:italic;
  color:#7a7a7a;
}

footer{
  margin-top:18px;
  text-align:center;
  font-size:12.5px;
  color:var(--muted);
}
</style>
</head>

<body>
<div class="wrap">

<h1>CEH Sustainable Consumer Guide</h1>
<div class="slogan" id="slogan"></div>

<div class="controls">
  <div class="controls-row">
    <input id="search" class="input" placeholder="Search name, product, category or practiceâ€¦" />
    <select id="locationFilter" class="select"></select>
    <select id="practiceFilter" class="select"></select>
    <button class="btn" onclick="resetFilters()">Reset filters</button>
  </div>
  <div class="meta" id="resultCount"></div>
</div>

<div class="grid" id="cards"></div>
<footer id="updated"></footer>

</div>

<script>
/* ========= DATA ========= */

const DATA_CSV =
  "https://docs.google.com/spreadsheets/d/1Nm4LnfbmopYYSSRL6oGt2trWsIehBKYeUf_rl2pKYYg/export?format=csv&gid=2076497318";

const SLOGAN_CSV =
  "https://docs.google.com/spreadsheets/d/1Nm4LnfbmopYYSSRL6oGt2trWsIehBKYeUf_rl2pKYYg/export?format=csv&gid=435440157";

/* ========= STATE ========= */

let allData = [];
let filtered = [];

let activeCategories = new Set();
let activePractices = new Set();

/* ========= HELPERS ========= */

const splitClean = v =>
  v ? v.split(",").map(x => x.trim()).filter(Boolean) : [];

const bulletise = text =>
  text ? text.split(".").map(t=>t.trim()).filter(Boolean)
    .map(t=>`
      <div class="bullet">
        <div class="chev">&gt;</div>
        <div>${t}.</div>
      </div>`).join("") : "";

/* ========= LOAD DATA ========= */

Papa.parse(DATA_CSV,{
  download:true,
  header:true,
  complete:r=>{
    allData = r.data.filter(x => x.Name);
    buildFilters();
    applyFilters();
    updated.textContent =
      "Data last updated: " + new Date().toLocaleDateString();
  }
});

/* ========= FILTERS ========= */

search.oninput =
locationFilter.onchange =
practiceFilter.onchange = applyFilters;

function resetFilters(){
  search.value="";
  locationFilter.value="";
  practiceFilter.value="";
  activeCategories.clear();
  activePractices.clear();
  applyFilters();
}

function togglePill(type,value){
  const set = type==="category" ? activeCategories : activePractices;
  set.has(value) ? set.delete(value) : set.add(value);
  applyFilters();
}

function applyFilters(){
  const q = search.value.toLowerCase();

  filtered = allData.filter(r=>{
    if(locationFilter.value && !r.Location?.includes(locationFilter.value)) return false;
    if(practiceFilter.value && !r.Practices?.includes(practiceFilter.value)) return false;

    const cats = splitClean(r.Category);
    const pracs = splitClean(r.Practices);

    if(activeCategories.size &&
       !cats.some(c=>activeCategories.has(c))) return false;

    if(activePractices.size &&
       !pracs.some(p=>activePractices.has(p))) return false;

    return JSON.stringify(r).toLowerCase().includes(q);
  });

  render();
}

/* ========= RENDER ========= */

function render(){
  cards.innerHTML = filtered.map(r=>`
    <div class="card">
      <div class="name">${r.Name}</div>
      <div class="bullets">${bulletise(r["Product/Service"])}</div>

      <div class="pills">
        ${splitClean(r.Category).map(c=>`
          <button class="pill blue ${activeCategories.has(c)?"active":""}"
            onclick="togglePill('category','${c.replace(/'/g,"&#39;")}')">${c}</button>
        `).join("")}
      </div>

      <div class="pills">
        ${splitClean(r.Practices).map(p=>`
          <button class="pill green ${activePractices.has(p)?"active":""}"
            onclick="togglePill('practice','${p.replace(/'/g,"&#39;")}')">${p}</button>
        `).join("")}
      </div>
    </div>
  `).join("");

  resultCount.textContent =
    `Showing ${filtered.length} of ${allData.length} results`;
}

/* ========= SLOGANS ========= */

Papa.parse(SLOGAN_CSV,{
  download:true,
  complete:r=>{
    const rows = r.data.slice(3,16).filter(x=>x[0]);
    let i=0;
    const show=()=>{
      const [txt,url,sec]=rows[i];
      slogan.innerHTML=url?`<a href="${url}" target="_blank">${txt}</a>`:txt;
      i=(i+1)%rows.length;
      setTimeout(show,(+sec||4)*1000);
    };
    if(rows.length) show();
  }
});
</script>
</body>
</html>
