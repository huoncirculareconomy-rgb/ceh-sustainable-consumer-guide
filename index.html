<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>CEH Sustainable Consumer Guide</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!--
====================================================================
CEH SUSTAINABLE CONSUMER GUIDE ‚Äî PURPOSE & EXPLANATION (FOR VOLUNTEERS)
====================================================================

What this page does
------------------
‚Ä¢ Loads the CEH Sustainable Consumer Guide from a Google Sheet (CSV)
‚Ä¢ Displays entries as cards, newest first
‚Ä¢ Allows filtering by:
    - Search text
    - Location (dropdown)
    - Practices (dropdown)
    - Category (blue pills)
    - Practices (green pills)
‚Ä¢ Provides a Reset Filters button
‚Ä¢ Shows ‚ÄúShowing X of Y results‚Äù

Why canonical categories & practices exist
------------------------------------------
As multiple volunteers contribute data, small wording differences
(e.g. "refill", "Refills", "BYO-containers") can fragment filters.
This script standardises those values internally so the interface
remains clean and consistent, without restricting spreadsheet entry.

Why website links are split
---------------------------
Some spreadsheet cells contain multiple website/social links.
These are now automatically separated and displayed individually
with appropriate icons (website, Facebook, Instagram, etc.).

Current status
--------------
‚úî Data loads correctly from Google Sheets
‚úî Filters behave correctly and independently
‚úî Cards closely match the original CEH styling
‚úî Safe for publication via GitHub Pages and Google Sites

====================================================================
-->

<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<style>
body {
  margin: 0;
  font-family: system-ui, Arial, sans-serif;
  background: #f6f3ee;
  color: #24323f;
}

.container {
  max-width: 1200px;
  margin: auto;
  padding: 20px;
}

h1 {
  color: #2f8f5b;
  margin-bottom: 4px;
}

.subtitle {
  font-style: italic;
  margin-bottom: 20px;
}

/* Filters */
.filters {
  display: grid;
  grid-template-columns: 1fr 220px 220px auto;
  gap: 10px;
  margin-bottom: 10px;
}

.filters input,
.filters select,
.filters button {
  padding: 8px 10px;
  font-size: 14px;
}

#resetBtn {
  background: #1a73e8;
  color: #ffffff;
  border: 1px solid #1a73e8;
  border-radius: 6px;
  cursor: pointer;
}

#resetBtn:hover {
  background: #1558b0;
}

@media (max-width: 800px) {
  .filters {
    grid-template-columns: 1fr;
  }
}

.results-count {
  font-size: 13px;
  margin: 10px 0;
}

/* Cards */
.cards {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
  gap: 16px;
}

.card {
  background: #fbfaf8;
  border: 1px solid #ddd;
  border-radius: 14px;
  padding: 16px;
}

.card h3 {
  margin-top: 0;
  margin-bottom: 6px;
}

.description {
  font-size: 14px;
  line-height: 1.5;
  margin-bottom: 8px;
}

/* Pills */
.category-tag,
.practice-tag {
  display: inline-block;
  padding: 4px 10px;
  font-size: 12px;
  border-radius: 999px;
  margin: 3px 4px 0 0;
  cursor: pointer;
  white-space: nowrap;
}

.category-tag {
  background: #e6f0ff;
  color: #2457c5;
  border: 1px solid #bcd2ff;
}

.practice-tag {
  background: #e7f5ea;
  color: #1b7f4d;
  border: 1px solid #bfe3cc;
}

/* Contact info */
.contact-block {
  margin-top: 10px;
  font-size: 13px;
}

.contact-item {
  display: flex;
  gap: 6px;
  margin-top: 3px;
  word-break: break-word;
}

.contact-icon {
  width: 16px;
  opacity: 0.75;
}
</style>
</head>

<body>
<div class="container">
  <h1>CEH Sustainable Consumer Guide</h1>
  <div class="subtitle">Choose local. Reduce waste. Strengthen the Huon Valley.</div>

  <div class="filters">
    <input id="searchInput" placeholder="Search businesses or services">
    <select id="locationFilter"><option value="">All locations</option></select>
    <select id="practiceFilter"><option value="">All practices</option></select>
    <button id="resetBtn">Reset filters</button>
  </div>

  <div class="results-count" id="resultsCount"></div>
  <div class="cards" id="cards"></div>
</div>

<script>
const CSV_URL =
  "https://docs.google.com/spreadsheets/d/1Nm4LnfbmopYYSSRL6oGt2trWsIehBKYeUf_rl2pKYYg/export?format=csv&gid=2076497318";

/* Canonical labels */
const CANONICAL_CATEGORIES = {
  "food & drink": "Food & Drink",
  "new-retail": "New Retail",
  "secondhand/reuse": "Secondhand / Reuse",
  "secondhand": "Secondhand / Reuse",
  "reuse": "Secondhand / Reuse"
};

const CANONICAL_PRACTICES = {
  "refill": "Refill",
  "refills": "Refill",
  "byo containers": "BYO containers",
  "byo-containers": "BYO containers",
  "plastic free": "Plastic-free",
  "plastic-free": "Plastic-free",
  "repair": "Repair",
  "recycle": "Recycle",
  "reuse": "Reuse"
};

let rows = [];
let filtered = [];
let activeCategory = "";

const searchInput = document.getElementById("searchInput");
const locationFilter = document.getElementById("locationFilter");
const practiceFilter = document.getElementById("practiceFilter");
const cardsEl = document.getElementById("cards");
const resultsCount = document.getElementById("resultsCount");

/* Helpers */
function parseList(value) {
  return (value || "")
    .split(",")
    .map(v => v.trim())
    .filter(Boolean);
}

function canonicalise(value, map) {
  const key = value.toLowerCase().trim();
  return map[key] || value.trim();
}

function parseCategories(value) {
  return parseList(value).map(v =>
    canonicalise(v, CANONICAL_CATEGORIES)
  );
}

function parsePractices(value) {
  return parseList(value).map(v =>
    canonicalise(v, CANONICAL_PRACTICES)
  );
}

/* Split multiple website / social links */
function splitLinks(value) {
  if (!value) return [];
  return value
    .split(/\n|,|\s+/)
    .map(v => v.trim())
    .filter(v => v.startsWith("http"));
}

function linkIcon(url) {
  if (url.includes("facebook.com")) return "üìò";
  if (url.includes("instagram.com")) return "üì∏";
  if (url.includes("twitter.com") || url.includes("x.com")) return "üê¶";
  return "üîó";
}

/* Load data */
Papa.parse(CSV_URL, {
  download: true,
  header: true,
  complete: res => {
    rows = res.data
      .filter(r => r.Status?.toLowerCase() === "active")
      .sort((a, b) => new Date(b.Date) - new Date(a.Date));

    populateFilters();
    applyFilters();
  }
});

function populateFilters() {
  const locations = new Set();
  const practices = new Set();

  rows.forEach(r => {
    parseList(r.Location).forEach(v => locations.add(v));
    parsePractices(r.Practices).forEach(v => practices.add(v));
  });

  [...locations].sort().forEach(l =>
    locationFilter.add(new Option(l, l))
  );

  [...practices].sort().forEach(p =>
    practiceFilter.add(new Option(p, p))
  );
}

/* Filtering */
function applyFilters() {
  const search = searchInput.value.toLowerCase();
  const loc = locationFilter.value;
  const prac = practiceFilter.value;

  filtered = rows.filter(r => {
    const text =
      `${r.Name} ${r["Product/Service"]} ${r.Notes}`.toLowerCase();

    if (search && !text.includes(search)) return false;
    if (loc && !parseList(r.Location).includes(loc)) return false;
    if (prac && !parsePractices(r.Practices).includes(prac)) return false;
    if (activeCategory && !parseCategories(r.Category).includes(activeCategory)) return false;

    return true;
  });

  render();
}

/* Render cards */
function render() {
  cardsEl.innerHTML = "";
  resultsCount.textContent =
    `Showing ${filtered.length} of ${rows.length} results`;

  filtered.forEach(r => {
    const card = document.createElement("div");
    card.className = "card";

    card.innerHTML = `
      <h3>${r.Name}</h3>
      <div class="description">${r["Product/Service"] || ""}</div>

      <div>
        ${parseCategories(r.Category)
          .map(c => `<span class="category-tag" data-cat="${c}">${c}</span>`)
          .join("")}
      </div>

      <div>
        ${parsePractices(r.Practices)
          .map(p => `<span class="practice-tag" data-practice="${p}">${p}</span>`)
          .join("")}
      </div>

      <div class="contact-block">
        ${splitLinks(r.Website).map(url => `
          <div class="contact-item">
            <span class="contact-icon">${linkIcon(url)}</span>
            <a href="${url}" target="_blank">${url}</a>
          </div>
        `).join("")}

        ${r.Email ? `
          <div class="contact-item">
            <span class="contact-icon">‚úâÔ∏è</span>
            <a href="mailto:${r.Email}">${r.Email}</a>
          </div>
        ` : ""}

        ${r.Phone ? `
          <div class="contact-item">
            <span class="contact-icon">üìû</span>
            <a href="tel:${r.Phone.replace(/\s+/g,"")}">${r.Phone}</a>
          </div>
        ` : ""}

        ${r.Address ? `
          <div class="contact-item">
            <span class="contact-icon">üìç</span>
            ${r.Address}
          </div>
        ` : ""}
      </div>
    `;

    cardsEl.appendChild(card);
  });

  document.querySelectorAll(".category-tag").forEach(el =>
    el.onclick = () => {
      activeCategory = el.dataset.cat;
      applyFilters();
    }
  );

  document.querySelectorAll(".practice-tag").forEach(el =>
    el.onclick = () => {
      practiceFilter.value = el.dataset.practice;
      applyFilters();
    }
  );
}

/* Events */
searchInput.oninput = applyFilters;
locationFilter.onchange = applyFilters;
practiceFilter.onchange = () => {
  activeCategory = "";
  applyFilters();
};

document.getElementById("resetBtn").onclick = () => {
  searchInput.value = "";
  locationFilter.value = "";
  practiceFilter.value = "";
  activeCategory = "";
  applyFilters();
};
</script>
</body>
</html>
