<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>CEH Sustainable Consumer Guide</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
/* ---------- Base ---------- */
body{
  font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Arial,sans-serif;
  background:#f8f6ef;
  margin:0;
  color:#1f2937;
}
.container{
  max-width:1200px;
  margin:auto;
  padding:20px;
}
h1{
  text-align:center;
  color:#2f855a;
  margin-bottom:6px;
}
#slogan{
  text-align:center;
  font-style:italic;
  margin-bottom:20px;
}

/* ---------- Filters ---------- */
.filters{
  display:flex;
  flex-wrap:wrap;
  gap:10px;
  align-items:center;
}
.filters input,
.filters select{
  height:42px;
  line-height:42px;
  padding:0 12px;
  font-size:14px;
  border:1px solid #ccc;
  border-radius:6px;
  box-sizing:border-box;
}
.filters input{flex:1 1 300px;}
.filters select{flex:0 0 180px;}

#resetBtn{
  background:#2563eb;
  color:#fff;
  border:none;
  padding:10px 14px;
  border-radius:6px;
  cursor:pointer;
}
#resetBtn:hover{background:#1d4ed8}

.results-count{
  margin:10px 0;
  font-size:14px;
}

/* ---------- Cards ---------- */
.cards{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(300px,1fr));
  gap:16px;
}
.card{
  background:#fff;
  border-radius:10px;
  padding:14px;
  border:1px solid #e5e7eb;
}
.card.featured{
  border:2px solid #2563eb;
  background:#eef2ff;
}
.card h3{
  margin-top:0;
}

/* ---------- Description ---------- */
.desc{
  font-size:14px;
  line-height:1.5;
}
.desc-line{
  display:block;
  padding-left:1.2em;
  text-indent:-1.2em;
  margin-bottom:4px;
}

/* ---------- Pills ---------- */
.pill{
  display:inline-block;
  padding:4px 10px;
  margin:4px 4px 0 0;
  border-radius:999px;
  font-size:12px;
  cursor:pointer;
  user-select:none;
}
.pill.category{
  background:#e0ecff;
  color:#1d4ed8;
  border:1px solid #bfdbfe;
}
.pill.practice{
  background:#e7f6eb;
  color:#166534;
  border:1px solid #bbf7d0;
}

/* ---------- Links ---------- */
.links{
  margin-top:8px;
  font-size:13px;
}
.links div{
  margin:2px 0;
}
.links a{
  color:#2563eb;
  text-decoration:none;
}
.links a:hover{text-decoration:underline}

/* ---------- Notes ---------- */
.notes{
  margin-top:8px;
  padding-top:6px;
  border-top:1px solid #e5e7eb;
  font-size:13px;
  font-style:italic;
  color:#6b7280;
}

/* ---------- Print ---------- */
@media print{
  .filters,.results-count,#resetBtn{display:none}
  body{background:#fff}
  .card{page-break-inside:avoid}
}
</style>
</head>

<body>
<div class="container">

<h1>CEH Sustainable Consumer Guide</h1>
<div id="slogan"></div>

<div class="filters">
  <input id="search" placeholder="Search name, product, category or practice‚Ä¶">
  <select id="locationFilter"><option value="">All locations</option></select>
  <select id="practiceFilter"><option value="">All practices</option></select>
  <button id="resetBtn">Reset filters</button>
</div>

<div class="results-count" id="count"></div>
<div class="cards" id="cards"></div>

<div style="margin-top:30px;font-size:12px;color:#6b7280;text-align:center" id="updated"></div>

</div>

<script>
/* ---------- CONFIG ---------- */
const DATA_CSV =
"https://docs.google.com/spreadsheets/d/1Nm4LnfbmopYYSSRL6oGt2trWsIehBKYeUf_rl2pKYYg/export?format=csv&gid=2076497318";

const SLOGAN_CSV =
"https://docs.google.com/spreadsheets/d/1Nm4LnfbmopYYSSRL6oGt2trWsIehBKYeUf_rl2pKYYg/export?format=csv&gid=435440157";

/* ---------- HELPERS ---------- */
function splitCSV(v){
  return v? v.split(",").map(s=>s.trim()).filter(Boolean):[];
}
function onlyLinks(text){
  if(!text) return [];
  return text.split(",").map(s=>s.trim()).filter(s=>s.startsWith("http"));
}
function formatDesc(text){
  if(!text) return "";
  return text.split(/\. +/).filter(Boolean).map(s=>{
    if(!s.endsWith(".")) s+=".";
    return `<span class="desc-line">&gt; ${s}</span>`;
  }).join("");
}
function mapsLink(addr){
  return addr?`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(addr)}`:"";
}

/* ---------- LOAD DATA ---------- */
let rows=[];
fetch(DATA_CSV).then(r=>r.text()).then(t=>{
  const [head,...lines]=t.split("\n").map(r=>r.split(","));
  rows=lines.map(l=>{
    const o={};
    head.forEach((h,i)=>o[h.trim()]=l[i]?.trim());
    return o;
  });
  initFilters();
  render();
  document.getElementById("updated").textContent=
    "Data last updated: "+new Date().toLocaleDateString();
});

/* ---------- FILTERS ---------- */
function initFilters(){
  const loc=new Set(), prac=new Set();
  rows.forEach(r=>{
    splitCSV(r.Location).forEach(l=>loc.add(l));
    splitCSV(r.Practices).forEach(p=>prac.add(p));
  });
  loc.forEach(l=>{
    locationFilter.add(new Option(l,l));
  });
  prac.forEach(p=>{
    practiceFilter.add(new Option(p,p));
  });
}
search.oninput=render;
locationFilter.onchange=render;
practiceFilter.onchange=render;
resetBtn.onclick=()=>{
  search.value="";
  locationFilter.value="";
  practiceFilter.value="";
  render();
};

/* ---------- RENDER ---------- */
function render(){
  const q=search.value.toLowerCase();
  const loc=locationFilter.value;
  const prac=practiceFilter.value;
  cards.innerHTML="";
  let shown=0;

  rows.forEach(r=>{
    if(r.Status && r.Status!=="Approved") return;
    if(loc && !splitCSV(r.Location).includes(loc)) return;
    if(prac && !splitCSV(r.Practices).includes(prac)) return;
    if(q && !JSON.stringify(r).toLowerCase().includes(q)) return;

    shown++;

    const featured = (r.Featured||"").toLowerCase()==="yes";

    const card=document.createElement("div");
    card.className="card"+(featured?" featured":"");
    card.innerHTML=`
      <h3>${r.Name||""}</h3>
      <div class="desc">${formatDesc(r["Product/Service"])}</div>

      ${splitCSV(r.Category).map(c=>
        `<span class="pill category" onclick="applyCategory('${c}')">${c}</span>`
      ).join("")}

      ${splitCSV(r.Practices).map(p=>
        `<span class="pill practice" onclick="applyPractice('${p}')">${p}</span>`
      ).join("")}

      <div class="links">
        ${onlyLinks(r.Website).map(u=>`<div>üîó <a href="${u}" target="_blank">${u}</a></div>`).join("")}
        ${r.Phone?`<div>üìû ${r.Phone}</div>`:""}
        ${r.Email?`<div>‚úâÔ∏è <a href="mailto:${r.Email}">${r.Email}</a></div>`:""}
        ${r.Address?`<div>üìç <a href="${mapsLink(r.Address)}" target="_blank">${r.Address}</a></div>`:""}
      </div>

      ${r.Notes?`<div class="notes">${r.Notes}</div>`:""}
    `;
    cards.appendChild(card);
  });

  count.textContent=`Showing ${shown} of ${rows.length} results`;
}

/* ---------- PILL FILTERS ---------- */
function applyCategory(c){
  search.value=c;
  render();
}
function applyPractice(p){
  practiceFilter.value=p;
  render();
}

/* ---------- SLOGANS ---------- */
fetch(SLOGAN_CSV).then(r=>r.text()).then(t=>{
  const rows=t.split("\n").slice(3,16).map(r=>r.split(","));
  let i=0;
  function rotate(){
    const [txt,url,sec]=rows[i];
    slogan.innerHTML=url?`<a href="${url}" target="_blank">${txt}</a>`:txt;
    i=(i+1)%rows.length;
    setTimeout(rotate,(parseInt(sec)||5)*1000);
  }
  rotate();
});
</script>
</body>
</html>
