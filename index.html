<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>CEH Sustainable Consumer Guide</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!--
====================================================================
CEH SUSTAINABLE CONSUMER GUIDE ‚Äì PURPOSE & EXPLANATION (FOR VOLUNTEERS)
====================================================================

What this page does:
- Loads the Sustainable Consumer Guide from a Google Sheet (as CSV)
- Displays each entry as a card
- Allows filtering by:
    ‚Ä¢ Search text
    ‚Ä¢ Location (dropdown)
    ‚Ä¢ Practices (dropdown)
    ‚Ä¢ Clicking Category (blue) or Practice (green) pills
- Sorts entries so the most recently added appear first
- Is designed to run reliably on GitHub Pages and inside Google Sites

Why canonical categories and practices were added:
As more volunteers contribute data, small differences in wording
(e.g. "refill", "Refills", "BYO-containers") can fragment filters
and create duplicate pills. This script standardises those values
behind the scenes so the guide stays clean and consistent, without
restricting how volunteers enter data in the spreadsheet.

Current status:
‚úî Data loads correctly from Google Sheets
‚úî Filters behave consistently
‚úî Layout matches the original CEH guide closely
‚úî Safe for publication via Google Sites

====================================================================
-->

<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<style>
body {
  margin: 0;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Arial, sans-serif;
  background: #f6f3ee;
  color: #24323f;
}

.container {
  max-width: 1200px;
  margin: auto;
  padding: 20px;
}

h1 {
  color: #2f8f5b;
  margin-bottom: 4px;
}

.subtitle {
  font-style: italic;
  margin-bottom: 20px;
}

.filters {
  display: grid;
  grid-template-columns: 1fr 220px 220px auto;
  gap: 10px;
  margin-bottom: 10px;
}

.filters input,
.filters select,
.filters button {
  padding: 8px 10px;
  font-size: 14px;
}

.filters button {
  cursor: pointer;
}

@media (max-width: 800px) {
  .filters {
    grid-template-columns: 1fr;
  }
}

.results-count {
  font-size: 13px;
  margin: 10px 0;
}

.cards {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
  gap: 16px;
}

.card {
  background: #fbfaf8;
  border: 1px solid #ddd;
  border-radius: 14px;
  padding: 16px;
}

.card h3 {
  margin-top: 0;
  margin-bottom: 6px;
}

.description {
  font-size: 14px;
  line-height: 1.5;
  margin-bottom: 8px;
}

.tag-row {
  margin-top: 6px;
}

.category-tag,
.practice-tag {
  display: inline-block;
  padding: 4px 10px;
  font-size: 12px;
  border-radius: 999px;
  margin: 3px 4px 0 0;
  cursor: pointer;
  white-space: nowrap;
}

.category-tag {
  background: #e6f0ff;
  color: #2457c5;
  border: 1px solid #bcd2ff;
}

.practice-tag {
  background: #e7f5ea;
  color: #1b7f4d;
  border: 1px solid #bfe3cc;
}

.contact-block {
  margin-top: 10px;
  font-size: 13px;
}

.contact-item {
  display: flex;
  gap: 6px;
  margin-top: 3px;
  word-break: break-word;
}

.contact-icon {
  width: 16px;
  opacity: 0.75;
}
</style>
</head>

<body>
<div class="container">
  <h1>CEH Sustainable Consumer Guide</h1>
  <div class="subtitle">Choose local. Reduce waste. Strengthen the Huon Valley.</div>

  <div class="filters">
    <input id="searchInput" placeholder="Search businesses or services">
    <select id="locationFilter"><option value="">All locations</option></select>
    <select id="practiceFilter"><option value="">All practices</option></select>
    <button id="resetBtn">Reset filters</button>
  </div>

  <div class="results-count" id="resultsCount"></div>
  <div class="cards" id="cards"></div>
</div>

<script>
const CSV_URL =
  "https://docs.google.com/spreadsheets/d/1Nm4LnfbmopYYSSRL6oGt2trWsIehBKYeUf_rl2pKYYg/export?format=csv&gid=2076497318";

// Canonical (standardised) labels
const CANONICAL_CATEGORIES = {
  "food & drink": "Food & Drink",
  "new-retail": "New Retail",
  "secondhand/reuse": "Secondhand / Reuse",
  "secondhand": "Secondhand / Reuse",
  "reuse": "Secondhand / Reuse"
};

const CANONICAL_PRACTICES = {
  "refill": "Refill",
  "refills": "Refill",
  "byo containers": "BYO containers",
  "byo-containers": "BYO containers",
  "plastic free": "Plastic-free",
  "plastic-free": "Plastic-free",
  "repair": "Repair",
  "recycle": "Recycle",
  "reuse": "Reuse"
};

let rows = [];
let filtered = [];

const searchInput = document.getElementById("searchInput");
const locationFilter = document.getElementById("locationFilter");
const practiceFilter = document.getElementById("practiceFilter");
const cardsEl = document.getElementById("cards");
const resultsCount = document.getElementById("resultsCount");

function parseList(value) {
  return (value || "")
    .split(",")
    .map(v => v.trim())
    .filter(Boolean);
}

function canonicalise(value, map) {
  const key = value.toLowerCase().trim();
  return map[key] || value.trim();
}

function parseCategories(value) {
  return parseList(value).map(v =>
    canonicalise(v, CANONICAL_CATEGORIES)
  );
}

function parsePractices(value) {
  return parseList(value).map(v =>
    canonicalise(v, CANONICAL_PRACTICES)
  );
}

Papa.parse(CSV_URL, {
  download: true,
  header: true,
  complete: res => {
    rows = res.data
      .filter(r => r.Status?.toLowerCase() === "active")
      .sort((a, b) => new Date(b.Date) - new Date(a.Date));

    populateFilters();
    applyFilters();
  }
});

function populateFilters() {
  const locations = new Set();
  const practices = new Set();

  rows.forEach(r => {
    parseList(r.Location).forEach(v => locations.add(v));
    parsePractices(r.Practices).forEach(v => practices.add(v));
  });

  [...locations].sort().forEach(l =>
    locationFilter.add(new Option(l, l))
  );

  [...practices].sort().forEach(p =>
    practiceFilter.add(new Option(p, p))
  );
}

function applyFilters() {
  const search = searchInput.value.toLowerCase();
  const loc = locationFilter.value;
  const prac = practiceFilter.value;

  filtered = rows.filter(r => {
    const text =
      `${r.Name} ${r["Product/Service"]} ${r.Notes}`.toLowerCase();

    if (search && !text.includes(search)) return false;
    if (loc && !parseList(r.Location).includes(loc)) return false;
    if (prac && !parsePractices(r.Practices).includes(prac)) return false;
    return true;
  });

  render();
}

function render() {
  cardsEl.innerHTML = "";
  resultsCount.textContent =
    `Showing ${filtered.length} of ${rows.length} results`;

  filtered.forEach(r => {
    const card = document.createElement("div");
    card.className = "card";

    card.innerHTML = `
      <h3>${r.Name}</h3>
      <div class="description">${r["Product/Service"] || ""}</div>

      <div class="tag-row">
        ${parseCategories(r.Category)
          .map(c => `<span class="category-tag" data-cat="${c}">${c}</span>`)
          .join("")}
      </div>

      <div class="tag-row">
        ${parsePractices(r.Practices)
          .map(p => `<span class="practice-tag" data-practice="${p}">${p}</span>`)
          .join("")}
      </div>

      <div class="contact-block">
        ${r.Website ? `<div class="contact-item"><span class="contact-icon">üîó</span><a href="${r.Website}" target="_blank">${r.Website}</a></div>` : ""}
        ${r.Email ? `<div class="contact-item"><span class="contact-icon">‚úâÔ∏è</span><a href="mailto:${r.Email}">${r.Email}</a></div>` : ""}
        ${r.Phone ? `<div class="contact-item"><span class="contact-icon">üìû</span><a href="tel:${r.Phone.replace(/\s+/g,"")}">${r.Phone}</a></div>` : ""}
        ${r.Address ? `<div class="contact-item"><span class="contact-icon">üìç</span>${r.Address}</div>` : ""}
      </div>
    `;

    cardsEl.appendChild(card);
  });

  document.querySelectorAll(".category-tag").forEach(el =>
    el.onclick = () => {
      searchInput.value = el.dataset.cat;
      locationFilter.value = "";
      practiceFilter.value = "";
      applyFilters();
    }
  );

  document.querySelectorAll(".practice-tag").forEach(el =>
    el.onclick = () => {
      practiceFilter.value = el.dataset.practice;
      applyFilters();
    }
  );
}

searchInput.oninput = applyFilters;
locationFilter.onchange = applyFilters;
practiceFilter.onchange = applyFilters;

document.getElementById("resetBtn").onclick = () => {
  searchInput.value = "";
  locationFilter.value = "";
  practiceFilter.value = "";
  applyFilters();
};
</script>
</body>
</html>
