<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">

<!--
PURPOSE & FUNCTION
This script renders the CEH Sustainable Consumer Guide as a searchable,
filterable card-based directory using data published as a CSV from
Google Sheets. It is designed to work reliably inside Google Sites
embeds, including on mobile devices. Location and Practice fields are
normalised so that combined values (e.g. "Huonville / Franklin") are
split into individual filter options, removing duplicates while still
matching records correctly.
-->

<style>
  * { box-sizing: border-box; }

  body {
    margin: 0;
    font-family: system-ui, Arial, sans-serif;
    background: transparent;
  }

  .container {
    padding: 12px;
  }

  h1 {
    margin: 0 0 6px;
    font-size: 1.4rem;
    color: #2E8B57;
  }

  .slogan {
    font-style: italic;
    color: #555;
    margin-bottom: 12px;
  }

  .controls {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-bottom: 12px;
  }

  input, select {
    padding: 10px;
    font-size: 14px;
    border-radius: 6px;
    border: 1px solid #ccc;
    flex: 1 1 200px;
  }

  .cards {
    display: grid;
    grid-template-columns: 1fr;
    gap: 10px;
  }

  @media (min-width: 700px) {
    .cards {
      grid-template-columns: repeat(2, 1fr);
    }
  }

  @media (min-width: 1000px) {
    .cards {
      grid-template-columns: repeat(3, 1fr);
    }
  }

  .card {
    border: 1px solid #ddd;
    border-radius: 10px;
    padding: 12px;
    background: #fff;
  }

  .card h3 {
    margin: 0 0 6px;
    font-size: 1.05rem;
  }

  .muted {
    color: #666;
    font-size: 0.9rem;
  }

  .tags {
    margin-top: 6px;
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
  }

  .tag {
    font-size: 12px;
    padding: 2px 8px;
    border-radius: 999px;
    background: #eef2ff;
    border: 1px solid #c7d2fe;
  }
</style>
</head>

<body>
<div class="container">

  <h1>CEH Sustainable Consumer Guide</h1>
  <div class="slogan" id="slogan">Loadingâ€¦</div>

  <div class="controls">
    <input id="search" placeholder="Search businesses or services">
    <select id="locationFilter">
      <option value="">All locations</option>
    </select>
    <select id="practiceFilter">
      <option value="">All practices</option>
    </select>
  </div>

  <div class="cards" id="cards"></div>

</div>

<script>
const CSV_URL =
  "https://docs.google.com/spreadsheets/d/e/2PACX-1vSuhA8ku2ftsdQaepAZucZWIHmVuwaLO2xq8_d8y5QIOBfCwRBDsWH9A5crAbsAcK3TFM1fcWMTVJjs/pub?output=csv";

function splitTokens(str) {
  if (!str) return [];
  return str.split(/[,;/|]/).map(s => s.trim()).filter(Boolean);
}

function norm(s) {
  return s.toLowerCase().replace(/\s+/g, " ").trim();
}

function parseCSV(text) {
  const lines = text.split(/\r?\n/);
  const headers = lines.shift().split(",");
  return lines
    .filter(l => l.trim())
    .map(l => {
      const cells = l.split(",");
      const obj = {};
      headers.forEach((h, i) => obj[h.trim()] = (cells[i] || "").trim());
      return obj;
    });
}

const state = {
  all: [],
  filtered: []
};

function renderFilters() {
  const locSet = new Set();
  const pracSet = new Set();

  state.all.forEach(r => {
    splitTokens(r.Location).forEach(l => locSet.add(l));
    splitTokens(r.Practices).forEach(p => pracSet.add(p));
  });

  const locSel = document.getElementById("locationFilter");
  [...locSet].sort().forEach(l => {
    const o = document.createElement("option");
    o.value = norm(l);
    o.textContent = l;
    locSel.appendChild(o);
  });

  const pracSel = document.getElementById("practiceFilter");
  [...pracSet].sort().forEach(p => {
    const o = document.createElement("option");
    o.value = norm(p);
    o.textContent = p;
    pracSel.appendChild(o);
  });
}

function applyFilters() {
  const q = document.getElementById("search").value.toLowerCase();
  const loc = document.getElementById("locationFilter").value;
  const prac = document.getElementById("practiceFilter").value;

  state.filtered = state.all.filter(r => {
    const textMatch =
      (r.Name || "").toLowerCase().includes(q) ||
      (r.Product || "").toLowerCase().includes(q);

    const locMatch =
      !loc ||
      splitTokens(r.Location).map(norm).includes(loc);

    const pracMatch =
      !prac ||
      splitTokens(r.Practices).map(norm).includes(prac);

    return textMatch && locMatch && pracMatch;
  });

  renderCards();
}

function renderCards() {
  const wrap = document.getElementById("cards");
  wrap.innerHTML = "";

  if (!state.filtered.length) {
    wrap.innerHTML = "<div class='muted'>No results found</div>";
    return;
  }

  state.filtered.forEach(r => {
    const card = document.createElement("div");
    card.className = "card";

    card.innerHTML = `
      <h3>${r.Name || ""}</h3>
      <div class="muted">${r.Product || ""}</div>
      <div class="muted">${r.Location || ""}</div>
      <div class="tags">
        ${splitTokens(r.Practices).map(p =>
          `<span class="tag">${p}</span>`).join("")}
      </div>
    `;
    wrap.appendChild(card);
  });
}

async function init() {
  const res = await fetch(CSV_URL, { cache: "no-store" });
  const text = await res.text();
  state.all = parseCSV(text);
  renderFilters();
  applyFilters();
  document.getElementById("slogan").textContent =
    "Choose local. Reduce waste. Strengthen the Huon Valley.";
}

document.getElementById("search").addEventListener("input", applyFilters);
document.getElementById("locationFilter").addEventListener("change", applyFilters);
document.getElementById("practiceFilter").addEventListener("change", applyFilters);

init();
</script>

</body>
</html>
