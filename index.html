<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>CEH Sustainable Consumer Guide</title>

<!--
PURPOSE & FUNCTION
This page loads a public CSV from Google Sheets and presents it as a searchable,
filterable directory of Huon Valley businesses. It normalises multi-value fields
(such as Locations and Practices), removes duplicates, and renders results as
responsive cards. All processing happens client-side; the spreadsheet remains
the single source of truth.
-->

<style>
  body {
    font-family: system-ui, Arial, sans-serif;
    margin: 0;
    padding: 20px;
    background: #f6f3ee;
  }

  h1 {
    color: #2e8b57;
    margin-bottom: 4px;
  }

  .subtitle {
    font-style: italic;
    margin-bottom: 20px;
  }

  .filters {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 10px;
    margin-bottom: 20px;
  }

  input, select {
    padding: 10px;
    font-size: 16px;
  }

  .cards {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 16px;
  }

  .card {
    background: #fff;
    border-radius: 8px;
    padding: 14px;
    box-shadow: 0 1px 4px rgba(0,0,0,0.1);
  }

  .card h3 {
    margin-top: 0;
  }

  .tag {
    display: inline-block;
    background: #e0f2e9;
    color: #205c3b;
    padding: 3px 8px;
    border-radius: 12px;
    font-size: 12px;
    margin: 2px 4px 2px 0;
  }

  a {
    color: #1a5fb4;
    text-decoration: none;
  }
</style>
</head>

<body>

<h1>CEH Sustainable Consumer Guide</h1>
<div class="subtitle">Choose local. Reduce waste. Strengthen the Huon Valley.</div>

<div class="filters">
  <input id="search" placeholder="Search businesses or services" />
  <select id="locationFilter">
    <option value="">All locations</option>
  </select>
  <select id="practiceFilter">
    <option value="">All practices</option>
  </select>
</div>

<div id="cards" class="cards"></div>

<script>
const CSV_URL =
  "https://docs.google.com/spreadsheets/d/e/2PACX-1vSuhA8ku2ftsdQaepAZucZWIHmVuwaLO2xq8_d8y5QIOBfCwRBDsWH9A5crAbsAcK3TFM1fcWMTVJjs/pub?output=csv";

const cardsEl = document.getElementById("cards");
const searchEl = document.getElementById("search");
const locEl = document.getElementById("locationFilter");
const pracEl = document.getElementById("practiceFilter");

let data = [];

/* ---------- helpers ---------- */

function splitTokens(str) {
  if (!str) return [];
  return str.split(/[,;/|]/).map(s => s.trim()).filter(Boolean);
}

function normalise(s) {
  return s.toLowerCase().replace(/\s+/g, " ").trim();
}

function parseCSV(text) {
  const [headerLine, ...rows] = text.trim().split(/\r?\n/);
  const headers = headerLine.split(",").map(h => h.trim());

  return rows.map(row => {
    const values = row.split(",");
    const obj = {};
    headers.forEach((h, i) => obj[h] = values[i] || "");
    return obj;
  });
}

/* ---------- render ---------- */

function renderFilters() {
  const locations = [...new Set(
    data.flatMap(r => splitTokens(r["Location"]))
  )].sort();

  const practices = [...new Set(
    data.flatMap(r => splitTokens(r["Practices"]))
  )].sort();

  locations.forEach(l => {
    const o = document.createElement("option");
    o.value = l;
    o.textContent = l;
    locEl.appendChild(o);
  });

  practices.forEach(p => {
    const o = document.createElement("option");
    o.value = p;
    o.textContent = p;
    pracEl.appendChild(o);
  });
}

function renderCards() {
  const q = normalise(searchEl.value);
  const loc = normalise(locEl.value);
  const prac = normalise(pracEl.value);

  cardsEl.innerHTML = "";

  data.filter(r => {
    const text = normalise(
      r["Name"] + " " + r["Product/Service"] + " " + r["Category"]
    );

    const locMatch = !loc || splitTokens(r["Location"]).map(normalise).includes(loc);
    const pracMatch = !prac || splitTokens(r["Practices"]).map(normalise).includes(prac);

    return (!q || text.includes(q)) && locMatch && pracMatch;
  }).forEach(r => {
    const card = document.createElement("div");
    card.className = "card";

    card.innerHTML = `
      <h3>${r["Name"]}</h3>
      <p><strong>${r["Product/Service"]}</strong></p>
      <p>${r["Notes"] || ""}</p>
      <p>
        ${splitTokens(r["Practices"]).map(p => `<span class="tag">${p}</span>`).join("")}
      </p>
      ${r["Website"] ? `<p><a href="${r["Website"]}" target="_blank">Website</a></p>` : ""}
    `;

    cardsEl.appendChild(card);
  });
}

/* ---------- init ---------- */

fetch(CSV_URL)
  .then(r => r.text())
  .then(text => {
    data = parseCSV(text).filter(r => r["Status"].toLowerCase() !== "inactive");
    renderFilters();
    renderCards();
  });

searchEl.addEventListener("input", renderCards);
locEl.addEventListener("change", renderCards);
pracEl.addEventListener("change", renderCards);
</script>

</body>
</html>
