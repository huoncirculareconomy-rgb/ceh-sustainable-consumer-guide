<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>CEH Sustainable Consumer Guide</title>

<!--
PURPOSE & FUNCTION
------------------
This page displays the CEH Sustainable Consumer Guide using data loaded
from a specific Google Sheets tab published as CSV.

Listings are shown as cards, sorted by most recent Date first.
Users can search, filter by Location or Practice, and click Category
or Practice pills to filter results.

Designed to run reliably on GitHub Pages and when embedded in Google Sites.
-->

<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<style>
body {
  margin: 0;
  font-family: system-ui, Arial, sans-serif;
  background: #f7f5f2;
  color: #1f2937;
}

.container {
  max-width: 1200px;
  margin: auto;
  padding: 16px;
}

h1 {
  color: #2e8b57;
  margin-bottom: 4px;
}

.subtitle {
  font-style: italic;
  margin-bottom: 16px;
}

/* Filters */
.filters {
  display: grid;
  grid-template-columns: 2fr 1fr 1fr auto;
  gap: 10px;
  margin-bottom: 10px;
}

.filters input,
.filters select,
.filters button {
  width: 100%;
  padding: 8px 10px;
  font-size: 14px;
  box-sizing: border-box;
}

.filters button {
  background: #ffffff;
  border: 1px solid #cbd5e1;
  border-radius: 6px;
  cursor: pointer;
}

.filters button:hover {
  background: #f1f5f9;
}

@media (max-width: 700px) {
  .filters {
    grid-template-columns: 1fr;
  }
}

.results-count {
  font-size: 13px;
  color: #4b5563;
  margin-bottom: 14px;
}

/* Cards */
.cards {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
  gap: 14px;
}

@media (max-width: 700px) {
  .cards {
    grid-template-columns: 1fr;
  }
}

.card {
  background: #f7f5f2;
  border: 1px solid #d9d9d9;
  border-radius: 14px;
  padding: 16px 18px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.05);
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.card h3 {
  margin: 0;
  font-size: 18px;
  font-weight: 600;
}

.description {
  font-size: 14.5px;
  line-height: 1.45;
  color: #374151;
}

/* Links */
.card a {
  font-size: 13px;
  color: #1a73e8;
  text-decoration: none;
  word-break: break-word;
}

.card a:hover {
  text-decoration: underline;
}

/* Category pills (blue) */
.category-tag {
  display: inline-block;
  padding: 4px 10px;
  font-size: 12px;
  border-radius: 999px;
  background: #e6f0ff;
  color: #1a4fb3;
  border: 1px solid #c7dcff;
  margin: 2px 6px 2px 0;
  cursor: pointer;
}

/* Practice pills (green) */
.practice-tag {
  display: inline-block;
  padding: 4px 10px;
  font-size: 12px;
  border-radius: 999px;
  background: #e6f4ea;
  color: #137333;
  border: 1px solid #b7dfc2;
  margin: 2px 6px 2px 0;
  cursor: pointer;
}

.practice-tag:hover,
.category-tag:hover {
  opacity: 0.85;
}
</style>
</head>

<body>
<div class="container">

<h1>CEH Sustainable Consumer Guide</h1>
<div class="subtitle">Choose local. Reduce waste. Strengthen the Huon Valley.</div>

<div class="filters">
  <input id="searchInput" placeholder="Search businesses or services" />
  <select id="locationFilter">
    <option value="">All locations</option>
  </select>
  <select id="practiceFilter">
    <option value="">All practices</option>
  </select>
  <button id="resetBtn">Reset filters</button>
</div>

<div class="results-count" id="resultsCount"></div>
<div class="cards" id="cards"></div>

</div>

<script>
const CSV_URL =
  "https://docs.google.com/spreadsheets/d/1Nm4LnfbmopYYSSRL6oGt2trWsIehBKYeUf_rl2pKYYg/export?format=csv&gid=2076497318";

let allRows = [];
let activeCategory = "";

/* Load CSV */
Papa.parse(CSV_URL, {
  download: true,
  header: true,
  skipEmptyLines: true,
  complete: res => {
    allRows = res.data
      .filter(r => r.Status && r.Status.toLowerCase().trim() === "active")
      .sort((a, b) => parseDate(b.Date) - parseDate(a.Date));

    buildFilters();
    render();
  },
  error: err => console.error("CSV error:", err)
});

function parseDate(v) {
  if (!v) return 0;
  if (/^\d{4}-\d{2}-\d{2}/.test(v)) return new Date(v).getTime() || 0;
  if (/^\d{1,2}[\/-]\d{1,2}[\/-]\d{4}$/.test(v)) {
    const [d, m, y] = v.split(/[\/-]/);
    return new Date(y, m - 1, d).getTime() || 0;
  }
  const t = Date.parse(v);
  return isNaN(t) ? 0 : t;
}

function buildFilters() {
  const locs = new Set();
  const pracs = new Set();

  allRows.forEach(r => {
    (r.Location || "").split(",").forEach(l => locs.add(l.trim()));
    (r.Practices || "").split(",").forEach(p => pracs.add(p.trim()));
  });

  [...locs].filter(Boolean).sort().forEach(l =>
    locationFilter.add(new Option(l, l))
  );
  [...pracs].filter(Boolean).sort().forEach(p =>
    practiceFilter.add(new Option(p, p))
  );
}

function render() {
  const q = searchInput.value.toLowerCase();
  const loc = locationFilter.value;
  const prac = practiceFilter.value;

  const filtered = allRows.filter(r => {
    if (q && !JSON.stringify(r).toLowerCase().includes(q)) return false;
    if (loc && !(r.Location || "").includes(loc)) return false;
    if (prac && !(r.Practices || "").includes(prac)) return false;
    if (activeCategory && !(r.Category || "").includes(activeCategory)) return false;
    return true;
  });

  cards.innerHTML = "";
  resultsCount.textContent =
    `Showing ${filtered.length} of ${allRows.length} results`;

  filtered.forEach(r => {
    const card = document.createElement("div");
    card.className = "card";

    card.innerHTML = `
      <h3>${r.Name || ""}</h3>
      <div class="description">${r["Product/Service"] || ""}</div>

      <div>
        ${(r.Category || "").split(",").map(c =>
          `<span class="category-tag" onclick="setCategory('${c.trim()}')">${c.trim()}</span>`
        ).join("")}
      </div>

      <div>
        ${(r.Practices || "").split(",").map(p =>
          `<span class="practice-tag" onclick="setPractice('${p.trim()}')">${p.trim()}</span>`
        ).join("")}
      </div>

      ${r.Website ? `<a href="${r.Website}" target="_blank">${r.Website}</a>` : ""}
    `;

    cards.appendChild(card);
  });
}

function setPractice(p) {
  practiceFilter.value = p;
  render();
}

function setCategory(c) {
  activeCategory = c;
  render();
}

searchInput.oninput = render;
locationFilter.onchange = render;
practiceFilter.onchange = () => {
  activeCategory = "";
  render();
};

resetBtn.onclick = () => {
  searchInput.value = "";
  locationFilter.value = "";
  practiceFilter.value = "";
  activeCategory = "";
  render();
};
</script>
</body>
</html>
