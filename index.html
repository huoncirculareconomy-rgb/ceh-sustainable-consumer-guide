<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>CEH Sustainable Consumer Guide</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!--
PURPOSE & FUNCTION
------------------
This page renders the Circular Economy Huon Sustainable Consumer Guide
from a Google Sheets CSV. It displays businesses as cards with search
and filters, clickable category and practice pills, contact details,
and notes. Addresses link to Google Maps. Website and social links are
automatically extracted from mixed text fields and shown with icons.
-->

<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<style>
body {
  margin: 0;
  font-family: system-ui, Arial, sans-serif;
  background: #f6f3ee;
  color: #24323f;
}

.container {
  max-width: 1200px;
  margin: auto;
  padding: 16px;
}

h1 {
  color: #2f8f5b;
  margin-bottom: 4px;
}

.subtitle {
  font-style: italic;
  margin-bottom: 16px;
}

/* Filters */
.filters {
  display: grid;
  grid-template-columns: 1fr 220px 220px auto;
  gap: 10px;
  margin-bottom: 10px;
}

.filters input,
.filters select,
.filters button {
  padding: 8px 10px;
  font-size: 14px;
}

#resetBtn {
  background: #1a73e8;
  color: #fff;
  border: 1px solid #1a73e8;
  border-radius: 6px;
  cursor: pointer;
}

#resetBtn:hover {
  background: #1558b0;
}

@media (max-width: 800px) {
  .filters {
    grid-template-columns: 1fr;
  }
}

.results-count {
  font-size: 13px;
  margin: 8px 0 12px;
}

/* Cards */
.cards {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
  gap: 16px;
}

.card {
  background: #fbfaf8;
  border: 1px solid #ddd;
  border-radius: 14px;
  padding: 14px;
}

.card h3 {
  margin: 0 0 6px 0;
  font-size: 16px;
}

.description {
  font-size: 14px;
  line-height: 1.45;
  margin-bottom: 8px;
}

/* Pills */
.category-tag,
.practice-tag {
  display: inline-block;
  padding: 4px 10px;
  font-size: 12px;
  border-radius: 999px;
  margin: 3px 4px 0 0;
  cursor: pointer;
  white-space: nowrap;
}

.category-tag {
  background: #e6f0ff;
  color: #2457c5;
  border: 1px solid #bcd2ff;
}

.practice-tag {
  background: #e7f5ea;
  color: #1b7f4d;
  border: 1px solid #bfe3cc;
}

/* Contact */
.contact {
  font-size: 13px;
  margin-top: 8px;
}

.contact-item {
  display: flex;
  align-items: flex-start;
  gap: 6px;
  margin-top: 3px;
}

.contact-item a {
  color: #1a73e8;
  text-decoration: none;
  font-size: 13px;
  word-break: break-word;
}

.contact-item a:hover {
  text-decoration: underline;
}

/* Notes */
.notes {
  margin-top: 10px;
  padding-top: 8px;
  border-top: 1px solid #eee;
  color: #777;
  font-style: italic;
  font-size: 13px;
}
</style>
</head>

<body>
<div class="container">

  <h1>CEH Sustainable Consumer Guide</h1>
  <div class="subtitle">Choose local. Reduce waste. Strengthen the Huon Valley.</div>

  <div class="filters">
    <input id="searchInput" placeholder="Search name, product, category or practice‚Ä¶">
    <select id="locationFilter"><option value="">All locations</option></select>
    <select id="practiceFilter"><option value="">All practices</option></select>
    <button id="resetBtn">Reset filters</button>
  </div>

  <div class="results-count" id="resultsCount"></div>
  <div class="cards" id="cards"></div>

</div>

<script>
const CSV_URL =
  "https://docs.google.com/spreadsheets/d/1Nm4LnfbmopYYSSRL6oGt2trWsIehBKYeUf_rl2pKYYg/export?format=csv&gid=2076497318";

let rows = [];
let filtered = [];
let activeCategory = "";

const searchInput = document.getElementById("searchInput");
const locationFilter = document.getElementById("locationFilter");
const practiceFilter = document.getElementById("practiceFilter");
const cardsEl = document.getElementById("cards");
const resultsCount = document.getElementById("resultsCount");

/* Helpers */
function list(val) {
  return (val || "").split(",").map(v => v.trim()).filter(Boolean);
}

function extractLinks(val) {
  if (!val) return [];
  const matches = val.match(/(https?:\/\/[^\s,]+|www\.[^\s,]+)/gi) || [];
  return matches.map(u => u.startsWith("http") ? u : "https://" + u);
}

function linkIcon(url) {
  if (url.includes("facebook.com")) return "üìò";
  if (url.includes("instagram.com")) return "üì∏";
  if (url.includes("twitter.com") || url.includes("x.com")) return "üê¶";
  return "üîó";
}

function mapsLink(address) {
  return "https://www.google.com/maps/search/?api=1&query=" +
         encodeURIComponent(address);
}

/* Load data */
Papa.parse(CSV_URL, {
  download: true,
  header: true,
  complete: res => {
    rows = res.data
      .filter(r => r.Status?.toLowerCase() === "active")
      .sort((a, b) => new Date(b.Date) - new Date(a.Date));

    populateFilters();
    applyFilters();
  }
});

function populateFilters() {
  const locations = new Set();
  const practices = new Set();

  rows.forEach(r => {
    list(r.Location).forEach(v => locations.add(v));
    list(r.Practices).forEach(v => practices.add(v));
  });

  [...locations].sort().forEach(v =>
    locationFilter.add(new Option(v, v))
  );
  [...practices].sort().forEach(v =>
    practiceFilter.add(new Option(v, v))
  );
}

function applyFilters() {
  const q = searchInput.value.toLowerCase();
  const loc = locationFilter.value;
  const prac = practiceFilter.value;

  filtered = rows.filter(r => {
    const text =
      `${r.Name} ${r["Product/Service"]} ${r.Category} ${r.Practices}`.toLowerCase();

    if (q && !text.includes(q)) return false;
    if (loc && !list(r.Location).includes(loc)) return false;
    if (prac && !list(r.Practices).includes(prac)) return false;
    if (activeCategory && !list(r.Category).includes(activeCategory)) return false;

    return true;
  });

  render();
}

function render() {
  cardsEl.innerHTML = "";
  resultsCount.textContent =
    `Showing ${filtered.length} of ${rows.length} results`;

  filtered.forEach(r => {
    const card = document.createElement("div");
    card.className = "card";

    const categoryHTML = list(r.Category)
      .map(c => `<span class="category-tag" data-cat="${c}">${c}</span>`)
      .join("");

    const practiceHTML = list(r.Practices)
      .map(p => `<span class="practice-tag" data-practice="${p}">${p}</span>`)
      .join("");

    const linksHTML = extractLinks(r.Website)
      .map(u => `
        <div class="contact-item">
          <span>${linkIcon(u)}</span>
          <a href="${u}" target="_blank">${u}</a>
        </div>
      `).join("");

    const addressHTML = r.Address
      ? `<div class="contact-item">
           <span>üìç</span>
           <a href="${mapsLink(r.Address)}" target="_blank">${r.Address}</a>
         </div>`
      : "";

    card.innerHTML = `
      <h3>${r.Name}</h3>
      <div class="description">${r["Product/Service"] || ""}</div>

      <div>${categoryHTML}</div>
      <div>${practiceHTML}</div>

      <div class="contact">
        ${linksHTML}
        ${r.Phone ? `<div class="contact-item"><span>üìû</span>${r.Phone}</div>` : ""}
        ${r.Email ? `<div class="contact-item"><span>‚úâÔ∏è</span><a href="mailto:${r.Email}">${r.Email}</a></div>` : ""}
        ${addressHTML}
      </div>

      ${r.Notes ? `<div class="notes">${r.Notes}</div>` : ""}
    `;

    cardsEl.appendChild(card);
  });

  document.querySelectorAll(".category-tag").forEach(el =>
    el.onclick = () => {
      activeCategory = el.dataset.cat;
      applyFilters();
    }
  );

  document.querySelectorAll(".practice-tag").forEach(el =>
    el.onclick = () => {
      practiceFilter.value = el.dataset.practice;
      applyFilters();
    }
  );
}

searchInput.oninput = applyFilters;
locationFilter.onchange = applyFilters;
practiceFilter.onchange = () => {
  activeCategory = "";
  applyFilters();
};

document.getElementById("resetBtn").onclick = () => {
  searchInput.value = "";
  locationFilter.value = "";
  practiceFilter.value = "";
  activeCategory = "";
  applyFilters();
};
</script>
</body>
</html>
