<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>CEH Sustainable Consumer Guide</title>

<!--
PURPOSE & FUNCTION
------------------
This page displays the CEH Sustainable Consumer Guide by loading data
from a specific Google Sheets tab (as CSV). The data is rendered as
searchable, filterable cards, sorted by most recent date first.

Locations are used for filtering only and are not displayed on cards.
Categories are displayed as blue pill-style buttons.
Practices are displayed as green pill-style buttons and are clickable.

Designed for GitHub Pages and safe to embed in Google Sites.
-->

<!-- Robust CSV parser -->
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<style>
/* ===== Base ===== */
body {
  margin: 0;
  font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  background: #f7f5f2;
  color: #1f2937;
}

.container {
  max-width: 1200px;
  margin: 0 auto;
  padding: 16px;
}

/* ===== Header ===== */
h1 {
  color: #2e8b57;
  margin-bottom: 4px;
}

.subtitle {
  font-style: italic;
  margin-bottom: 16px;
}

/* ===== Filters ===== */
.filters {
  display: grid;
  grid-template-columns: 2fr 1fr 1fr auto;
  gap: 10px;
  margin-bottom: 8px;
}

.filters input,
.filters select,
.filters button {
  width: 100%;
  box-sizing: border-box;
  padding: 8px 10px;
  font-size: 14px;
}

.filters button {
  background: #ffffff;
  border: 1px solid #cbd5e1;
  border-radius: 6px;
  cursor: pointer;
}

.filters button:hover {
  background: #f1f5f9;
}

@media (max-width: 700px) {
  .filters {
    grid-template-columns: 1fr;
  }
}

/* ===== Results count ===== */
.results-count {
  font-size: 13px;
  margin: 8px 0 14px;
  color: #4b5563;
}

/* ===== Cards grid ===== */
.cards {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
  gap: 14px;
}

@media (max-width: 700px) {
  .cards {
    grid-template-columns: 1fr;
  }
}

/* ===== Card ===== */
.card {
  background: #f7f5f2;
  border: 1px solid #d9d9d9;
  border-radius: 14px;
  padding: 16px 18px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.05);
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.card h3 {
  margin: 0;
  font-size: 18px;
  font-weight: 600;
}

/* ===== Text ===== */
.description {
  font-size: 14.5px;
  line-height: 1.45;
  color: #374151;
}

/* ===== Links ===== */
.card a {
  font-size: 13px;
  color: #1a73e8;
  text-decoration: none;
  word-break: break-word;
}

.card a:hover {
  text-decoration: underline;
}

/* ===== Category tag (blue) ===== */
.category-tag {
  display: inline-block;
  padding: 4px 10px;
  font-size: 12px;
  border-radius: 999px;
  background: #e6f0ff;
  color: #1a4fb3;
  border: 1px solid #c7dcff;
  margin: 2px 6px 2px 0;
}

/* ===== Practice tag (green) ===== */
.practice-tag {
  display: inline-block;
  padding: 4px 10px;
  font-size: 12px;
  border-radius: 999px;
  background: #e6f4ea;
  color: #137333;
  border: 1px solid #b7dfc2;
  margin: 2px 6px 2px 0;
  cursor: pointer;
}

.practice-tag:hover {
  background: #d2eddc;
}
</style>
</head>

<body>
<div class="container">

<h1>CEH Sustainable Consumer Guide</h1>
<div class="subtitle">Choose local. Reduce waste. Strengthen the Huon Valley.</div>

<div class="filters">
  <input id="searchInput" placeholder="Search businesses or services" />
  <select id="locationFilter">
    <option value="">All locations</option>
  </select>
  <select id="practiceFilter">
    <option value="">All practices</option>
  </select>
  <button id="resetBtn">Reset filters</button>
</div>

<div class="results-count" id="resultsCount"></div>
<div class="cards" id="cards"></div>

</div>

<script>
/* =========================
   DATA SOURCE (LOCKED)
   ========================= */
const CSV_URL =
  "https://docs.google.com/spreadsheets/d/1Nm4LnfbmopYYSSRL6oGt2trWsIehBKYeUf_rl2pKYYg/export?format=csv&gid=2076497318";

let allRows = [];

/* =========================
   LOAD CSV
   ========================= */
Papa.parse(CSV_URL, {
  download: true,
  header: true,
  skipEmptyLines: true,
  complete: function (results) {
    allRows = results.data
      .filter(r => r.Status && r.Status.trim().toLowerCase() === "active")
      .sort((a, b) => parseDate(b.Date) - parseDate(a.Date));

    buildFilters();
    render();
  },
  error: function (err) {
    console.error("CSV load error:", err);
  }
});

/* =========================
   DATE PARSER
   ========================= */
function parseDate(value) {
  if (!value) return 0;

  if (/^\d{4}-\d{2}-\d{2}/.test(value)) {
    return new Date(value).getTime() || 0;
  }

  if (/^\d{1,2}[\/-]\d{1,2}[\/-]\d{4}$/.test(value)) {
    const [d, m, y] = value.split(/[\/-]/);
    return new Date(y, m - 1, d).getTime() || 0;
  }

  const t = Date.parse(value);
  return isNaN(t) ? 0 : t;
}

/* =========================
   BUILD FILTER OPTIONS
   ========================= */
function buildFilters() {
  const locSet = new Set();
  const pracSet = new Set();

  allRows.forEach(r => {
    (r.Location || "").split(",").forEach(l => locSet.add(l.trim()));
    (r.Practices || "").split(",").forEach(p => pracSet.add(p.trim()));
  });

  [...locSet].filter(Boolean).sort().forEach(l =>
    locationFilter.add(new Option(l, l))
  );

  [...pracSet].filter(Boolean).sort().forEach(p =>
    practiceFilter.add(new Option(p, p))
  );
}

/* =========================
   RENDER
   ========================= */
function render() {
  const q = searchInput.value.toLowerCase();
  const loc = locationFilter.value;
  const prac = practiceFilter.value;

  const filtered = allRows.filter(r => {
    if (q && !JSON.stringify(r).toLowerCase().includes(q)) return false;
    if (loc && !(r.Location || "").includes(loc)) return false;
    if (prac && !(r.Practices || "").includes(prac)) return false;
    return true;
  });

  cards.innerHTML = "";
  resultsCount.textContent =
    `Showing ${filtered.length} of ${allRows.length} results`;

  filtered.forEach(r => {
    const card = document.createElement("div");
    card.className = "card";

    card.innerHTML = `
      <h3>${r.Name || ""}</h3>
      <div class="description">${r["Product/Service"] || ""}</div>
      ${r.Category ? `<span class="category-tag">${r.Category}</span>` : ""}
      <div>
        ${(r.Practices || "").split(",").map(p =>
          `<span class="practice-tag" onclick="setPractice('${p.trim()}')">${p.trim()}</span>`
        ).join("")}
      </div>
      ${r.Website ? `<a href="${r.Website}" target="_blank">${r.Website}</a>` : ""}
    `;

    cards.appendChild(card);
  });
}

/* =========================
   EVENTS
   ========================= */
searchInput.oninput = render;
locationFilter.onchange = render;
practiceFilter.onchange = render;

resetBtn.onclick = () => {
  searchInput.value = "";
  locationFilter.value = "";
  practiceFilter.value = "";
  render();
};

function setPractice(p) {
  practiceFilter.value = p;
  render();
}
</script>
</body>
</html>
